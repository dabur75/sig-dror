<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×©×™×‘×•×¥ ×—×•×“×©×™ - ×¡×™×’×œ×™×ª</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="header-functions.js"></script>
    <style>
        /* Header Styles */
        #main-navbar {
          background: #ede7f6; /* ×¨×§×¢ ×¡×’×•×œ ×‘×”×™×¨ */
          box-shadow: 0 2px 12px #e4e6eb33;
            border-radius: 0 0 18px 18px;
            padding: 0 0 0 0;
          margin-bottom: 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 64px;
          direction: rtl;
        }
        
        #main-navbar .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-right: 24px;
        }
        
        #main-navbar .logo img {
            height: 40px;
            width: auto;
        }
        
        #main-navbar nav {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        #main-navbar nav a {
            color: #4a5568;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
            font-size: 14px;
        }
        
        #main-navbar nav a:hover {
            background: #d1c4e9;
            color: #2d3748;
        }
        
        #main-navbar nav a.active {
            background: #7c3aed;
            color: white;
        }
        
        #main-navbar .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: 24px;
        }
        
        #main-navbar .user-info span {
            color: #4a5568;
            font-weight: 500;
            font-size: 14px;
        }
        
        #main-navbar .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }
        
        #main-navbar .logout-btn:hover {
            background: #dc2626;
        }
        
        /* Footer Styles */
        #main-footer {
            width: 100%;
          background: #fff;
          color: #8a99b3;
            text-align: center;
            padding: 18px 0 10px 0;
            font-size: 1.08em;
          font-weight: 500;
            border-radius: 18px 18px 0 0;
          box-shadow: 0 -2px 12px #e4e6eb33;
            letter-spacing: 0.03em;
        }
        
        #main-footer .footer-icon {
            font-size: 1.3em;
            margin-left: 7px;
          color: #4891ca;
          filter: drop-shadow(0 0 2px #e3f1fb);
        }
        
        @media (max-width: 700px) {
            #main-footer { font-size: 0.98em; padding: 12px 0 7px 0; }
        }
        body {
            font-family: 'Heebo', Arial, sans-serif;
            background: #f8fafd;
            margin: 0;
            padding: 10px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        /* Header Section */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 700;
        }
        
        .month-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 8px;
        }
        
        .month-selector select {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            background: white;
            color: #333;
            min-width: 100px;
        }
        
        /* Toolbar */
        .toolbar {
            background: #f8fafc;
            padding: 10px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .toolbar-section {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .toolbar-section h3 {
            margin: 0;
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
            margin-left: 8px;
        }
        
        /* Button Styles */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }
        
        .btn-warning:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
            transform: translateY(-1px);
        }
        
        /* Draft Management */
        .draft-section {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .draft-select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
            min-width: 120px;
        }
        
        /* Main Content */
        .main-content {
            padding: 20px 30px;
        }
        
        .schedule-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 10px;
            table-layout: auto;
        }
        
        .schedule-table th,
        .schedule-table td {
            width: 14.28%; /* 100% / 7 days = 14.28% */
            box-sizing: border-box;
        }
        
        .schedule-table tr {
            height: 35px;
        }
        
        .schedule-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 6px;
            text-align: center;
            font-weight: 600;
            border-radius: 6px 6px 0 0;
            font-size: 11px;
            line-height: 1.2;
        }
        
        .schedule-table td {
            background: white;
            border: 1px solid #e2e8f0;
            padding: 4px 2px;
            text-align: center;
            vertical-align: top;
            height: 35px;
            border-radius: 4px;
            transition: all 0.2s ease;
            overflow: hidden;
            position: relative;
        }
        
        .schedule-table td:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .day-number {
            font-weight: 700;
            font-size: 12px;
            color: #1e293b;
            margin-bottom: 1px;
            line-height: 1;
        }
        
        .day-guides {
            display: flex;
            flex-direction: column;
            gap: 1px;
            margin-bottom: 1px;
        }
        
        .guide-item-display {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 3px;
            padding: 1px 3px;
            font-size: 9px;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .guide-item-display:hover {
            background: #e2e8f0;
            transform: scale(1.02);
        }
        
        .guide-overlap {
            border-color: #3b82f6;
            color: #1e40af;
            font-weight: 600;
        }
        
        .guide-regular {
            border-color: #10b981;
            color: #065f46;
            font-weight: 500;
        }
        
        .guide-conan-friday {
            border-color: #f59e0b;
            color: #92400e;
            font-weight: 600;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }
        
        /* Individual guide colors - maintaining role distinction but with personal tones */
        .guide-dana.guide-overlap { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); }
        .guide-dana.guide-regular { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); }
        
        .guide-michal.guide-overlap { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); }
        .guide-michal.guide-regular { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); }
        
        .guide-yossi.guide-overlap { background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); }
        .guide-yossi.guide-regular { background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%); }
        
        .guide-ronit.guide-overlap { background: linear-gradient(135deg, #fbcfe8 0%, #f9a8d4 100%); }
        .guide-ronit.guide-regular { background: linear-gradient(135deg, #f7fee7 0%, #ecfccb 100%); }
        
        .guide-uri.guide-overlap { background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%); }
        .guide-uri.guide-regular { background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%); }
        
        .guide-sara.guide-overlap { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); }
        .guide-sara.guide-regular { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); }
        
        .guide-tal.guide-overlap { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
        .guide-tal.guide-regular { background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); }
        
        .guide-roni.guide-overlap { background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%); }
        .guide-roni.guide-regular { background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%); }
        
        .guide-noa.guide-overlap { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); }
        .guide-noa.guide-regular { background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); }
        
        .guide-amit.guide-overlap { background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); }
        .guide-amit.guide-regular { background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%); }
        
        .guide-role-label {
            font-size: 9px;
            opacity: 0.8;
            font-weight: 400;
            display: block;
        }
        
        .guide-name {
            font-weight: 600;
            display: block;
        }
        
        .edit-day-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-top: 8px;
        }
        
        /* Weekend styles */
        .weekend-open {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-color: #10b981;
        }
        
        .weekend-closed {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: #ef4444;
        }
        
        .sabbath {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #f59e0b;
        }
        
        /* Status Bar */
        .status-bar {
            background: #f8fafc;
            padding: 15px 30px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #64748b;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-success { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-error { background: #ef4444; }
        
        /* Traffic Light System */
        .traffic-light {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .traffic-light-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .traffic-light-green {
            background: #10b981;
        }
        
        .traffic-light-yellow {
            background: #f59e0b;
        }
        
        .traffic-light-red {
            background: #ef4444;
        }
        
        .availability-reason {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
            padding: 4px 8px;
            background: #f1f5f9;
            border-radius: 4px;
            border-left: 3px solid #94a3b8;
        }
        
        .override-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding: 8px;
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 6px;
        }
        
        .override-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        .override-toggle label {
            font-size: 12px;
            color: #92400e;
            font-weight: 500;
        }
        
        .manual-badge, .auto-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
            margin-top: 4px;
            display: inline-block;
        }
        
        .manual-badge {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        
        .auto-badge {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        .no-assignments {
            text-align: center;
            color: #64748b;
            font-style: italic;
            padding: 20px;
        }
        
        /* Constraint Tags */
        .constraint-tags {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 8px;
        }
        
        .constraint-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            max-width: 100%;
        }
        
        .constraint-icon {
            font-size: 12px;
        }
        
        .constraint-text {
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Constraint Type Colors */
        .constraint-vacation {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        
        .constraint-constraint {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .constraint-fixed_constraint {
            background-color: #e0e7ff;
            color: #3730a3;
            border: 1px solid #a5b4fc;
        }
        
        .constraint-consecutive {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        
        .constraint-blocked {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .constraint-workload_high {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .constraint-workload_medium {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        
        .constraint-weekly_rule {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        
        .constraint-coordinator_rule {
            background-color: #f3e8ff;
            color: #7c3aed;
            border: 1px solid #c084fc;
        }
        
        .constraint-info {
            background-color: #dbeafe;
            color: #1d4ed8;
            border: 1px solid #93c5fd;
        }
        
        /* Enhanced traffic light colors */
        .traffic-light-indicator.yellow {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        
        .traffic-light-indicator.red {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }
        
        .traffic-light-indicator.green {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }
        
        /* Section headers for traffic light categories */
        .section-header {
            margin: 15px 0 10px 0;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            border: 2px solid;
        }
        
        .section-header.recommended {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border-color: #10b981;
        }
        
        .section-header.not-recommended {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border-color: #f59e0b;
        }
        
        .section-header h5 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Icons */
        .icon {
            width: 16px;
            height: 16px;
            display: inline-block;
        }
        
        /* Side Panel Styles */
        .side-panel-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .side-panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 380px;
            max-width: 90vw;
            background: white;
            box-shadow: -6px 0 24px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }
        
        .side-panel.open {
            transform: translateX(0);
        }
        
        .side-panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            position: relative;
        }
        
        .side-panel-close {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .side-panel-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .side-panel-title {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
        }
        
        .side-panel-date {
            text-align: center;
            margin-top: 4px;
            font-size: 12px;
            opacity: 0.9;
        }
        
        .side-panel-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }
        
        .panel-section {
            margin-bottom: 32px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin: 0 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        /* Selected Guides */
        .selected-guides-container {
            margin-bottom: 12px;
        }
        
        .selected-guide-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
        }
        
        .guide-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .guide-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
        }
        
        .guide-role {
            font-size: 12px;
            color: #64748b;
        }
        
        .remove-guide-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }
        
        .remove-guide-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: scale(1.1);
        }
        
        .assignment-status {
            text-align: center;
            margin-top: 8px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-complete {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .status-partial {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .status-empty {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        /* Guide Items */
        .guides-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .guide-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .guide-item.available {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-color: #e2e8f0;
        }
        
        .guide-item.available:hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            transform: translateX(4px);
            border-color: #94a3b8;
        }
        
        .guide-item.available.selected {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: #3b82f6;
            color: #1e40af;
        }
        
        .guide-item.blocked {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: #fca5a5;
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .guide-item.blocked-override {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #fcd34d;
            border-style: dashed;
            cursor: pointer;
        }
        
        .guide-item.blocked-override:hover {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
        }
        
        .guide-item.blocked-override.selected {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-color: #f59e0b;
            color: white;
        }
        
        .guide-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-available {
            background: #10b981;
        }
        
        .status-blocked {
            background: #ef4444;
        }
        
        .status-warning {
            background: #f59e0b;
        }
        
        /* Override Section */
        .override-section {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border: 2px solid #fcd34d;
            border-radius: 12px;
            padding: 16px;
        }
        
        .override-toggle {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-weight: 600;
            color: #92400e;
        }
        
        .toggle-input {
            display: none;
        }
        
        .toggle-slider {
            position: relative;
            width: 44px;
            height: 24px;
            background: #cbd5e1;
            border-radius: 24px;
            transition: all 0.3s ease;
        }
        
        .toggle-slider::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-input:checked + .toggle-slider {
            background: #f59e0b;
        }
        
        .toggle-input:checked + .toggle-slider::before {
            transform: translateX(20px);
        }
        
        .override-description {
            font-size: 12px;
            color: #92400e;
            opacity: 0.8;
        }
        
        /* Side Panel Footer */
        .side-panel-footer {
            padding: 20px 24px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .side-panel-footer .btn {
            min-width: 100px;
        }
        
        /* Responsive for side panel */
        @media (max-width: 768px) {
            .side-panel {
                width: 100vw;
            }
            
            .side-panel-content {
                padding: 20px 16px;
            }
            
            .side-panel-footer {
                padding: 16px;
                flex-direction: column;
            }
            
            .side-panel-footer .btn {
                width: 100%;
            }
        }

        .weekend-type-control {
            margin-top: 8px;
            padding: 4px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 4px;
            max-width: 100%;
            overflow: hidden;
        }

        .weekend-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #6b7280;
            cursor: pointer;
        }

        .weekend-checkbox input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: #8b5cf6;
        }

        .checkbox-label {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60px;
        }
        
        .flexibility-notice {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #1e40af;
        }
        
        .notice-icon {
            font-size: 14px;
        }
        
        .notice-text {
            font-weight: 500;
            line-height: 1.3;
        }
        
        /* Statistics Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .close {
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .stats-section {
            margin-bottom: 30px;
        }
        
        .stats-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
        }
        
        .stat-label {
            font-weight: 500;
            color: #555;
        }
        
        .stat-value {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1rem;
        }
        
        .guides-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        /* Workflow Status Modal Styles */
        .workflow-status {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.finalized {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.draft {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.editable {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.locked {
            background: #f8d7da;
            color: #721c24;
        }

        .drafts-section {
            margin-top: 20px;
        }

        .drafts-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .drafts-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .draft-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }

        .draft-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .draft-info strong {
            color: #333;
            font-size: 14px;
        }

        .draft-meta {
            color: #6c757d;
            font-size: 12px;
            margin-top: 5px;
        }

        /* Workflow Status Panel Styles */
        .workflow-status-panel {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-bottom: 2px solid #667eea;
            padding: 8px 20px;
            margin-bottom: 0;
        }

        .workflow-status.finalized {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #ef4444;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
        }

        .workflow-status.active {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            border-radius: 6px;
            padding: 8px;
        }

        .workflow-status h4 {
            margin: 0 0 6px 0;
            font-size: 14px;
            font-weight: 700;
        }

        /* Coordinator Rules Modal Styles */
        .rules-section {
            margin-bottom: 20px;
        }

        .rules-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .rules-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.2rem;
        }

        .rules-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .rule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 8px;
            border: 1px solid #cbd5e1;
        }

        .rule-info {
            flex: 1;
        }

        .rule-type {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .rule-icon {
            font-size: 18px;
        }

        .rule-title {
            font-weight: 600;
            color: #374151;
        }

        .rule-description {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .rule-guides {
            color: #059669;
            font-weight: 500;
            font-size: 14px;
        }

        .rule-actions {
            display: flex;
            gap: 5px;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* Form Styles for New Rule */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .guide-stat {
            background: linear-gradient(135deg, #fff5f5, #fed7d7);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #feb2b2;
        }
        
        .guide-name {
            font-weight: bold;
            color: #c53030;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .guide-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .guide-stats-grid span {
            background: rgba(255, 255, 255, 0.7);
            padding: 5px 8px;
            border-radius: 4px;
            text-align: center;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="main-navbar">
        <div class="logo">
            <img src="sigalitlogo.png" alt="×¡×™×’×œ×™×ª">
            <span style="font-size: 1.5em; font-weight: 700; color: #254b77;">×¡×™×’×œ×™×ª</span>
        </div>
        <nav>
            <a href="dashboard.html">×¢××•×“ ×”×‘×™×ª</a>
            <a href="schedule.html">×¡×™×“×•×¨ ×—×•×“×©×™</a>
            <a href="weekly_activities.html">×œ×•"×– ×©×‘×•×¢×™</a>
            <a href="guides.html">× ×™×”×•×œ ×¦×•×•×ª</a>
            <a href="constraints.html">××™×œ×•×¦×™× ×•×—×•×¤×©×•×ª</a>
            <a href="tasks.html">××©×™××•×ª ×—×¤×™×¤×”</a>
            <a href="scheduler.html" id="scheduler-link" style="display:none;" class="active">×©×™×‘×•×¥</a>
            <a href="reports.html" id="reports-link" style="display:none;">×“×•×—×•"×ª</a>
        </nav>
        <div class="user-info">
            <span id="header-user">×˜×•×¢×Ÿ...</span>
            <span id="header-role">×˜×•×¢×Ÿ...</span>
            <button class="logout-btn" onclick="logout()">×”×ª× ×ª×§</button>
        </div>
    </div>

    <!-- Coordinator Access Check -->
    <script>
        // Check if user is coordinator
        function checkCoordinatorAccess() {
            const role = localStorage.getItem('role');
            console.log('Checking coordinator access, role:', role);
            
            // Check if user is logged in
            if (!role) {
                console.log('No role found, redirecting to login');
                window.location.href = 'login.html';
                return false;
            }
            
            // Check if user is coordinator
            if (role !== '×¨×›×–' && role !== '×¨×›×–×ª') {
                console.log('User is not coordinator, redirecting to dashboard');
                window.location.href = 'dashboard.html';
                return false;
            }
            
            console.log('Coordinator access granted');
            return true;
        }
        
        // Show/hide coordinator links
        function showCoordinatorLinks() {
            const role = localStorage.getItem('role');
            const schedulerLink = document.getElementById('scheduler-link');
            const reportsLink = document.getElementById('reports-link');
            
            if (schedulerLink) {
                schedulerLink.style.display = (role === '×¨×›×–' || role === '×¨×›×–×ª') ? 'inline-block' : 'none';
            }
            if (reportsLink) {
                reportsLink.style.display = (role === '×¨×›×–' || role === '×¨×›×–×ª') ? 'inline-block' : 'none';
            }
        }
        
        // Check access on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkCoordinatorAccess();
            showCoordinatorLinks();
            renderHeaderUser();
        });
    </script>

    <div class="container">
        <!-- Header with Month Selection -->
        <div class="header">
            <h1>×©×™×‘×•×¥ ×—×•×“×©×™ - ×¡×™×’×œ×™×ª</h1>
            <div class="month-selector">
                <label>×‘×—×™×¨×ª ×—×•×“×©:</label>
                <select id="month-select">
                    <option value="2025-01">×™× ×•××¨ 2025</option>
                    <option value="2025-02">×¤×‘×¨×•××¨ 2025</option>
                    <option value="2025-03">××¨×¥ 2025</option>
                    <option value="2025-04">××¤×¨×™×œ 2025</option>
                    <option value="2025-05">×××™ 2025</option>
                    <option value="2025-06" selected>×™×•× ×™ 2025</option>
                    <option value="2025-07">×™×•×œ×™ 2025</option>
                    <option value="2025-08">××•×’×•×¡×˜ 2025</option>
                    <option value="2025-09">×¡×¤×˜××‘×¨ 2025</option>
                    <option value="2025-10">××•×§×˜×•×‘×¨ 2025</option>
                    <option value="2025-11">× ×•×‘××‘×¨ 2025</option>
                    <option value="2025-12">×“×¦××‘×¨ 2025</option>
                </select>
                <button class="btn btn-primary">×˜×¢×Ÿ ×—×•×“×©</button>
            </div>
        </div>

        <!-- Toolbar with organized buttons -->
        <div class="toolbar">
            <!-- Automatic Scheduling -->
            <div class="toolbar-section">
                <h3>×©×™×‘×•×¥ ××•×˜×•××˜×™</h3>
                <button class="btn btn-success" onclick="runAutoScheduling()">
                    <span class="icon">ğŸ¤–</span>
                    ×©×‘×¥ ××•×˜×•××˜×™×ª
                </button>
                <button class="btn btn-danger" onclick="removeAutoScheduled()">
                    <span class="icon">ğŸ—‘ï¸</span>
                    ××—×§ ×©×™×‘×•×¥ ××•×˜×•××˜×™
                </button>
            </div>

            <!-- Workflow Process (will be added dynamically) -->
            <!-- This section will be managed by updateWorkflowButtons() function -->



            <!-- Rules & Settings -->
            <div class="toolbar-section">
                <h3>×—×•×§×™× ×•×”×’×“×¨×•×ª</h3>
                <button class="btn btn-secondary" onclick="handleToolbarAction('×—×•×§×™ ×©×™×‘×•×¥')">
                    <span class="icon">ğŸ“‹</span>
                    ×—×•×§×™ ×©×™×‘×•×¥
                </button>
                <button class="btn btn-info" onclick="handleToolbarAction('×¡×˜×˜×™×¡×˜×™×§×•×ª')">
                    <span class="icon">ğŸ“ˆ</span>
                    ×¡×˜×˜×™×¡×˜×™×§×•×ª
                </button>
            </div>

            <!-- Actions -->
            <div class="toolbar-section">
                <h3>×¤×¢×•×œ×•×ª</h3>
                <button class="btn btn-warning" onclick="handleToolbarAction('× ×§×” ×”×›×œ')">
                    <span class="icon">ğŸ—‘ï¸</span>
                    × ×§×” ×”×›×œ
                </button>
                <button class="btn btn-primary" onclick="handleToolbarAction('×™×™×¦× ×œ××§×¡×œ')">
                    <span class="icon">ğŸ“¤</span>
                    ×™×™×¦× ×œ××§×¡×œ
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <table class="schedule-table">
                <thead>
                    <tr>
                        <th>×¨××©×•×Ÿ</th>
                        <th>×©× ×™</th>
                        <th>×©×œ×™×©×™</th>
                        <th>×¨×‘×™×¢×™</th>
                        <th>×—××™×©×™</th>
                        <th>×©×™×©×™</th>
                        <th>×©×‘×ª</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <div class="day-number">1</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-dana">
                                    <span class="guide-role-label">××“×¨×™×š ×—×¤×™×¤×”</span>
                                    <span class="guide-name">×“× ×”</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-michal">
                                    <span class="guide-role-label">××“×¨×™×š ×¨×’×™×œ</span>
                                    <span class="guide-name">××™×›×œ</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">×¢×¨×•×š</button>
                        </td>
                        <td>
                            <div class="day-number">2</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-yossi">
                                    <span class="guide-role-label">××“×¨×™×š ×—×¤×™×¤×”</span>
                                    <span class="guide-name">×™×•×¡×™</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-ronit">
                                    <span class="guide-role-label">××“×¨×™×š ×¨×’×™×œ</span>
                                    <span class="guide-name">×¨×•× ×™×ª</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">×¢×¨×•×š</button>
                        </td>
                        <td>
                            <div class="day-number">3</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-uri">
                                    <span class="guide-role-label">××“×¨×™×š ×—×¤×™×¤×”</span>
                                    <span class="guide-name">××•×¨×™</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-sara">
                                    <span class="guide-role-label">××“×¨×™×š ×¨×’×™×œ</span>
                                    <span class="guide-name">×©×¨×”</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">×¢×¨×•×š</button>
                        </td>
                        <td>
                            <div class="day-number">4</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-tal">
                                    <span class="guide-role-label">××“×¨×™×š ×—×¤×™×¤×”</span>
                                    <span class="guide-name">×˜×œ</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-roni">
                                    <span class="guide-role-label">××“×¨×™×š ×¨×’×™×œ</span>
                                    <span class="guide-name">×¨×•× ×™</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">×¢×¨×•×š</button>
                        </td>
                        <td>
                            <div class="day-number">5</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-noa">
                                    <span class="guide-role-label">××“×¨×™×š ×—×¤×™×¤×”</span>
                                    <span class="guide-name">× ×•×¢×”</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-amit">
                                    <span class="guide-role-label">××“×¨×™×š ×¨×’×™×œ</span>
                                    <span class="guide-name">×¢××™×ª</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">×¢×¨×•×š</button>
                        </td>
                        <td class="weekend-open">
                            <div class="day-number">6</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-dana">
                                    <span class="guide-role-label">××“×¨×™×š ×—×¤×™×¤×”</span>
                                    <span class="guide-name">×“× ×”</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-yossi">
                                    <span class="guide-role-label">××“×¨×™×š ×¨×’×™×œ</span>
                                    <span class="guide-name">×™×•×¡×™</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">×¢×¨×•×š</button>
                        </td>
                        <td class="sabbath">
                            <div class="day-number">7</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-michal">
                                    <span class="guide-role-label">××“×¨×™×š ×—×¤×™×¤×”</span>
                                    <span class="guide-name">××™×›×œ</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-uri">
                                    <span class="guide-role-label">××“×¨×™×š ×¨×’×™×œ</span>
                                    <span class="guide-name">××•×¨×™</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">×¢×¨×•×š</button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div class="day-number">8</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-sara">
                                    <span class="guide-role-label">××“×¨×™×š ×—×¤×™×¤×”</span>
                                    <span class="guide-name">×©×¨×”</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-tal">
                                    <span class="guide-role-label">××“×¨×™×š ×¨×’×™×œ</span>
                                    <span class="guide-name">×˜×œ</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">×¢×¨×•×š</button>
                        </td>
                        <td>
                            <div class="day-number">9</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-roni">
                                    <span class="guide-role-label">××“×¨×™×š ×—×¤×™×¤×”</span>
                                    <span class="guide-name">×¨×•× ×™</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-noa">
                                    <span class="guide-role-label">××“×¨×™×š ×¨×’×™×œ</span>
                                    <span class="guide-name">× ×•×¢×”</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">×¢×¨×•×š</button>
                        </td>
                        <td>
                            <div class="day-number">10</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-amit">
                                    <span class="guide-role-label">××“×¨×™×š ×—×¤×™×¤×”</span>
                                    <span class="guide-name">×¢××™×ª</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-dana">
                                    <span class="guide-role-label">××“×¨×™×š ×¨×’×™×œ</span>
                                    <span class="guide-name">×“× ×”</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">×¢×¨×•×š</button>
                        </td>
                        <td>
                            <div class="day-number">11</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-yossi">
                                    <span class="guide-role-label">××“×¨×™×š ×—×¤×™×¤×”</span>
                                    <span class="guide-name">×™×•×¡×™</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-michal">
                                    <span class="guide-role-label">××“×¨×™×š ×¨×’×™×œ</span>
                                    <span class="guide-name">××™×›×œ</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">×¢×¨×•×š</button>
                        </td>
                        <td>
                            <div class="day-number">12</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-uri">
                                    <span class="guide-role-label">××“×¨×™×š ×—×¤×™×¤×”</span>
                                    <span class="guide-name">××•×¨×™</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-sara">
                                    <span class="guide-role-label">××“×¨×™×š ×¨×’×™×œ</span>
                                    <span class="guide-name">×©×¨×”</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">×¢×¨×•×š</button>
                        </td>
                        <td class="weekend-open">
                            <div class="day-number">13</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-tal">
                                    <span class="guide-role-label">××“×¨×™×š ×—×¤×™×¤×”</span>
                                    <span class="guide-name">×˜×œ</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-roni">
                                    <span class="guide-role-label">××“×¨×™×š ×¨×’×™×œ</span>
                                    <span class="guide-name">×¨×•× ×™</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">×¢×¨×•×š</button>
                        </td>
                        <td class="sabbath">
                            <div class="day-number">14</div>
                            <div class="day-guides">
                                <div class="guide-item-display guide-overlap guide-noa">
                                    <span class="guide-role-label">××“×¨×™×š ×—×¤×™×¤×”</span>
                                    <span class="guide-name">× ×•×¢×”</span>
                                </div>
                                <div class="guide-item-display guide-regular guide-amit">
                                    <span class="guide-role-label">××“×¨×™×š ×¨×’×™×œ</span>
                                    <span class="guide-name">×¢××™×ª</span>
                                </div>
                            </div>
                            <button class="edit-day-btn">×¢×¨×•×š</button>
                        </td>
                    </tr>
                    <!-- More rows would be generated dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator status-success"></div>
                <span>28 ×™××™× ×©×•×‘×¦×•</span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-warning"></div>
                <span>2 ×™××™× ×¢× ×—×¨×™×’×•×ª</span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-error"></div>
                <span>1 ×™×•× ×œ× ×©×•×‘×¥</span>
            </div>
            <div class="status-item">
                <span>×¢×“×›×•×Ÿ ××—×¨×•×Ÿ: 15:30</span>
            </div>
        </div>
    </div>

    <!-- Side Panel Overlay -->
    <div id="side-panel-overlay" class="side-panel-overlay"></div>
    
    <!-- Side Panel -->
    <div id="side-panel" class="side-panel">
        <div class="side-panel-header">
            <button class="side-panel-close" id="side-panel-close">Ã—</button>
            <h3 class="side-panel-title">×¢×¨×™×›×ª ×©×™×‘×•×¥ ×™×•××™</h3>
            <div class="side-panel-date">×™×•× ×¨×‘×™×¢×™, 11 ×‘×™×•× ×™ 2025</div>
        </div>
        
        <div class="side-panel-content">
            <!-- Current Assignment -->
            <div class="panel-section">
                <h4 class="section-title">××“×¨×™×›×™× × ×‘×—×¨×™×</h4>
                <div class="flexibility-notice">
                    <span class="notice-icon">ğŸ’¡</span>
                    <span class="notice-text">××¤×©×¨ ×œ×©×‘×¥ ××“×¨×™×š ××—×“ ××• ×©× ×™×™× - ×”×©×™×‘×•×¥ ×”××•×˜×•××˜×™ ×™×©×œ×™× ××ª ×”×©××¨</span>
                </div>
                <div class="selected-guides-container">
                    <div class="selected-guide-item">
                        <div class="guide-info">
                            <span class="guide-name">×™×•×¡×™ ×›×”×Ÿ</span>
                            <span class="guide-role">××“×¨×™×š ×‘×›×™×¨</span>
                        </div>
                        <button class="remove-guide-btn">Ã—</button>
                    </div>
                    <div class="selected-guide-item">
                        <div class="guide-info">
                            <span class="guide-name">××™×›×œ ×œ×•×™</span>
                            <span class="guide-role">××“×¨×™×›×”</span>
                        </div>
                        <button class="remove-guide-btn">Ã—</button>
                    </div>
                </div>
                <div class="assignment-status">
                    <span class="status-badge status-complete">×©×™×‘×•×¥ ××œ× (2/2)</span>
                </div>
            </div>

            <!-- Available Guides -->
            <div class="panel-section">
                <h4 class="section-title">××“×¨×™×›×™× ×–××™× ×™× ×œ×©×™×‘×•×¥</h4>
                <div class="guides-list">
                    <!-- Available guides will be populated by JavaScript -->
                </div>
            </div>

            <!-- Blocked Guides -->
            <div class="panel-section">
                <h4 class="section-title">××“×¨×™×›×™× ×—×¡×•××™×</h4>
                <div class="guides-list">
                    <!-- Blocked guides will be populated by JavaScript -->
                </div>
            </div>

            <!-- Override Section -->
            <div class="panel-section override-section">
                <div class="override-toggle">
                    <label class="toggle-label">
                        <input type="checkbox" id="manual-override" class="toggle-input">
                        <span class="toggle-slider"></span>
                        <span class="toggle-text">Manual Override - ×¢×§×•×£ ×—×¡×™××•×ª</span>
                    </label>
                    <div class="override-description">
                        ×××¤×©×¨ ×œ×©×‘×¥ ××“×¨×™×›×™× ×—×¡×•××™× ×‘×”×ª×¢×œ××•×ª ××—×•×§×™ ×”××¢×¨×›×ª
                    </div>
                </div>
            </div>
        </div>

        <!-- Side Panel Footer -->
        <div class="side-panel-footer">
            <button class="btn btn-secondary" onclick="closeSidePanel()">×‘×™×˜×•×œ</button>
            <button class="btn btn-primary" onclick="saveChanges()">×©××•×¨ ×©×™× ×•×™×™×</button>
        </div>
    </div>

    <script>
        // Phase 1 Task 3: Frontend Integration with Backend API
        const API_BASE = 'http://localhost:4000/api';
        let sidePanelOpen = false;
        let currentMonth = '2025-06';
        let currentDate = null;
        let selectedGuides = [];
        let guidesData = [];
        let assignmentTypes = [];
        let shiftTypes = [];

        // Add these variables at the top of your script section
        let workflowStatus = null;
        let availableDrafts = [];
        let isFinalized = false;

        // =====================================================
        // API INTEGRATION FUNCTIONS
        // =====================================================

        async function fetchGuides() {
            try {
                const response = await fetch(`${API_BASE}/guides/enhanced`);
                guidesData = await response.json();
                console.log('Guides loaded:', guidesData);
                return guidesData;
            } catch (error) {
                console.error('Error fetching guides:', error);
                showNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ×”××“×¨×™×›×™×', 'error');
            }
        }

        async function fetchGuideAvailability(date) {
            try {
                const response = await fetch(`${API_BASE}/guides/availability/${date}`);
                const availability = await response.json();
                console.log('Availability for', date, ':', availability);
                return availability;
            } catch (error) {
                console.error('Error fetching availability:', error);
                showNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ×–××™× ×•×ª', 'error');
            }
        }

        async function fetchMonthlySchedule(year, month) {
            try {
                const response = await fetch(`${API_BASE}/schedule/enhanced/${year}/${month}`);
                const schedule = await response.json();
                console.log('Schedule loaded:', schedule);
                return schedule;
            } catch (error) {
                console.error('Error fetching schedule:', error);
                showNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ×œ×•×— ×”×©× ×”', 'error');
            }
        }

        async function fetchAssignmentTypes() {
            try {
                const response = await fetch(`${API_BASE}/assignment-types`);
                assignmentTypes = await response.json();
                console.log('Assignment types loaded:', assignmentTypes);
                return assignmentTypes;
            } catch (error) {
                console.error('Error fetching assignment types:', error);
            }
        }

        async function fetchShiftTypes() {
            try {
                const response = await fetch(`${API_BASE}/shift-types`);
                shiftTypes = await response.json();
                console.log('Shift types loaded:', shiftTypes);
                return shiftTypes;
            } catch (error) {
                console.error('Error fetching shift types:', error);
            }
        }

        async function saveManualAssignment(date, guide1Id, guide2Id, type) {
            try {
                const requestData = {
                    date: date,
                    guide1_id: guide1Id,
                    guide2_id: guide2Id,
                    type: type,
                    created_by: 1 // TODO: Get from user session
                };
                
                console.log('Sending request data:', requestData);
                
                const response = await fetch(`${API_BASE}/schedule/manual`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                console.log('Response status:', response.status);
                console.log('Response data:', result);
                
                if (result.success) {
                    showNotification('×”×©×™×‘×•×¥ × ×©××¨ ×‘×”×¦×œ×—×”', 'success');
                    return true;
                } else {
                    showNotification(`×©×’×™××” ×‘×©××™×¨×ª ×”×©×™×‘×•×¥: ${result.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error saving manual assignment:', error);
                showNotification('×©×’×™××” ×‘×©××™×¨×ª ×”×©×™×‘×•×¥', 'error');
                return false;
            }
        }

        async function saveDraft(month, name, data) {
            try {
                const response = await fetch(`${API_BASE}/drafts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        month: month,
                        name: name,
                        data: data,
                        created_by: 1 // TODO: Get from user session
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('×”×˜×™×•×˜×” × ×©××¨×” ×‘×”×¦×œ×—×”', 'success');
                    return result;
                } else {
                    showNotification('×©×’×™××” ×‘×©××™×¨×ª ×”×˜×™×•×˜×”', 'error');
                    return null;
                }
            } catch (error) {
                console.error('Error saving draft:', error);
                showNotification('×©×’×™××” ×‘×©××™×¨×ª ×”×˜×™×•×˜×”', 'error');
                return null;
            }
        }

        // =====================================================
        // UI UPDATE FUNCTIONS
        // =====================================================

        function updateCalendarWithSchedule(schedule) {
            const calendarBody = document.querySelector('.schedule-table tbody');
            if (!calendarBody) return;

            // Clear existing content
            calendarBody.innerHTML = '';

            // Get current month and year from the schedule or use current selection
            let year, month;
            if (schedule && schedule.length > 0) {
                const firstDay = new Date(schedule[0].date);
                year = firstDay.getFullYear();
                month = firstDay.getMonth();
            } else {
                [year, month] = currentMonth.split('-').map(Number);
                month = month - 1; // JavaScript months are 0-based
            }

            // Generate calendar days for the month
            const weeks = generateCalendarDays(year, month, schedule);
            
            weeks.forEach(week => {
                const row = document.createElement('tr');
                
                week.forEach(day => {
                    const cell = document.createElement('td');
                    
                    if (day) {
                        cell.innerHTML = createDayCell(day);
                    } else {
                        cell.innerHTML = '<div class="day-number">-</div>';
                    }
                    
                    row.appendChild(cell);
                });
                
                calendarBody.appendChild(row);
            });
        }

        function generateCalendarDays(year, month, schedule) {
            const weeks = [];
            let currentWeek = [];
            
            // Get first day of month and last day of month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Get day of week for first day (0 = Sunday, 1 = Monday, etc.)
            const firstDayOfWeek = firstDay.getDay();
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDayOfWeek; i++) {
                currentWeek.push(null);
            }
            
            // Add all days of the month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                // Use local date formatting to avoid timezone issues
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                console.log(`Generated date for day ${day}: ${dateString} (${date.toDateString()})`);
                
                // Find if there's schedule data for this day
                const scheduleDay = schedule ? schedule.find(s => s.date === dateString) : null;
                
                if (scheduleDay) {
                    currentWeek.push(scheduleDay);
                } else {
                    // Create empty day object
                    currentWeek.push({
                        date: dateString,
                        guide1_name: null,
                        guide2_name: null,
                        is_manual: false,
                        is_locked: false
                    });
                }
                
                // If we've reached Saturday (6), start a new week
                if (date.getDay() === 6) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                }
            }
            
            // Add remaining days to the last week
            if (currentWeek.length > 0) {
                weeks.push(currentWeek);
            }
            
            return weeks;
        }
        
        function groupScheduleByWeeks(schedule) {
            const weeks = [];
            let currentWeek = [];
            
            schedule.forEach(day => {
                const dayOfWeek = new Date(day.date).getDay();
                
                // Start new week on Sunday (0)
                if (dayOfWeek === 0 && currentWeek.length > 0) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                }
                
                currentWeek.push(day);
                
                // End week on Saturday (6)
                if (dayOfWeek === 6) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                }
            });
            
            // Add remaining days
            if (currentWeek.length > 0) {
                weeks.push(currentWeek);
            }
            
            return weeks;
        }

        function createDayCell(day) {
            const dayNumber = new Date(day.date).getDate();
            const isManual = day.is_manual;
            const isLocked = day.is_locked;
            const dayOfWeek = new Date(day.date).getDay();
            const isFriday = dayOfWeek === 5; // Friday is day 5
            const isSaturday = dayOfWeek === 6; // Saturday is day 6
            
            // Check if this is a closed Saturday weekend
            let isClosedSaturdayWeekend = false;
            let fridayConanGuide = null;
            
            if (isSaturday) {
                // Check if the previous Friday is marked as closed Saturday
                const fridayDate = new Date(day.date);
                fridayDate.setDate(fridayDate.getDate() - 1);
                const fridayString = fridayDate.toISOString().split('T')[0];
                
                // Check if Friday has closed Saturday setting
                const fridayCheckbox = document.querySelector(`input[data-date="${fridayString}"]`);
                if (fridayCheckbox && fridayCheckbox.checked) {
                    isClosedSaturdayWeekend = true;
                    
                    // Get the conan guide from Friday
                    const fridayDay = window.currentMonthSchedule?.find(d => d.date === fridayString);
                    if (fridayDay && fridayDay.guide1_name && fridayDay.guide1_role === '×›×•× ×Ÿ') {
                        fridayConanGuide = fridayDay.guide1_name;
                    }
                }
            }
            
            let cellHtml = `<div class="day-number">${dayNumber}</div>`;
            
            // For closed Saturday, show the conan guide from Friday with special styling
            if (isClosedSaturdayWeekend && fridayConanGuide) {
                cellHtml += `
                    <div class="guide-item-display guide-conan-friday guide-${fridayConanGuide.toLowerCase()}">
                        <span class="guide-role-label">×›×•× ×Ÿ ×©×™×©×™/×©×‘×ª (×¢×“ 17:00)</span>
                        <span class="guide-name">${fridayConanGuide}</span>
                    </div>
                `;
            }
            
            // Show regular assignments (excluding the conan guide if it's already shown)
            if (day.guide1_name && (!isClosedSaturdayWeekend || day.guide1_name !== fridayConanGuide)) {
                let guide1Class = isManual ? 'guide-overlap' : 'guide-regular';
                let guide1Role = day.guide1_role;
                
                // For closed Saturday, show the additional guide if exists
                if (isClosedSaturdayWeekend && day.guide1_name !== fridayConanGuide) {
                    guide1Class = 'guide-overlap';
                    guide1Role = '××•×¦×´×© (17:00-19:00) + ×¨×’×™×œ (19:00-24:00)';
                }
                
                cellHtml += `
                    <div class="guide-item-display ${guide1Class} guide-${day.guide1_name.toLowerCase()}">
                        <span class="guide-role-label">${guide1Role}</span>
                        <span class="guide-name">${day.guide1_name}</span>
                    </div>
                `;
            }
            
            if (day.guide2_name) {
                const guide2Class = isManual ? 'guide-overlap' : 'guide-regular';
                cellHtml += `
                    <div class="guide-item-display ${guide2Class} guide-${day.guide2_name.toLowerCase()}">
                        <span class="guide-role-label">${day.guide2_role}</span>
                        <span class="guide-name">${day.guide2_name}</span>
                    </div>
                `;
            }
            
            cellHtml += `<button class="edit-day-btn" onclick="editDay('${day.date}')" data-date="${day.date}">×¢×¨×•×š</button>`;
            
            // Add visual indicators for manual assignments
            if (isManual) {
                cellHtml += '<div class="manual-indicator">ğŸ”’</div>';
            }
            
            // Add weekend type checkbox for Fridays
            if (isFriday) {
                cellHtml += `
                    <div class="weekend-type-control">
                        <label class="weekend-checkbox">
                            <input type="checkbox" onchange="toggleWeekendType('${day.date}', this.checked)" data-date="${day.date}">
                            <span class="checkbox-label">×©×‘×ª ×¡×’×•×¨×”</span>
                        </label>
                    </div>
                `;
            }
            
            return cellHtml;
        }

        function updateSidePanelWithAvailability(availability) {
            // Find the available guides section (second panel-section)
            const availableSection = document.querySelector('.panel-section:nth-child(2)');
            const blockedSection = document.querySelector('.panel-section:nth-child(3)');
            
            if (!availableSection || !blockedSection) {
                console.error('Could not find sections:', { availableSection, blockedSection });
                return;
            }
            
            const availableContainer = availableSection.querySelector('.guides-list');
            const blockedContainer = blockedSection.querySelector('.guides-list');
            
            if (!availableContainer || !blockedContainer) {
                console.error('Could not find containers:', { availableContainer, blockedContainer });
                return;
            }
            
            // Clear existing content
            availableContainer.innerHTML = '';
            blockedContainer.innerHTML = '';
            
            // Filter out already selected guides
            const selectedGuideNames = selectedGuides.map(name => name);
            const filteredAvailability = availability.filter(guide => !selectedGuideNames.includes(guide.guide_name));
            
            console.log('Processing availability data:', filteredAvailability);
            console.log('Selected guides to filter out:', selectedGuideNames);
            
            // Separate guides by traffic light status
            const recommendedGuides = [];
            const notRecommendedGuides = [];
            const blockedGuides = [];
            
            filteredAvailability.forEach(guide => {
                const trafficLightStatus = calculateTrafficLightStatus(guide);
                
                if (trafficLightStatus === 'green') {
                    recommendedGuides.push(guide);
                } else if (trafficLightStatus === 'yellow') {
                    notRecommendedGuides.push(guide);
                } else {
                    blockedGuides.push(guide);
                }
            });
            
            // Create sections with headers
            if (recommendedGuides.length > 0) {
                const recommendedHeader = document.createElement('div');
                recommendedHeader.className = 'section-header recommended';
                recommendedHeader.innerHTML = '<h5>ğŸŸ¢ ××•××œ×¥</h5>';
                availableContainer.appendChild(recommendedHeader);
                
                recommendedGuides.forEach(guide => {
                    const guideElement = createGuideElement(guide);
                    availableContainer.appendChild(guideElement);
                });
            }
            
            if (notRecommendedGuides.length > 0) {
                const notRecommendedHeader = document.createElement('div');
                notRecommendedHeader.className = 'section-header not-recommended';
                notRecommendedHeader.innerHTML = '<h5>ğŸŸ¡ ×œ× ××•××œ×¥</h5>';
                availableContainer.appendChild(notRecommendedHeader);
                
                notRecommendedGuides.forEach(guide => {
                    const guideElement = createGuideElement(guide);
                    availableContainer.appendChild(guideElement);
                });
            }
            
            if (blockedGuides.length > 0) {
                blockedGuides.forEach(guide => {
                    const guideElement = createGuideElement(guide);
                    blockedContainer.appendChild(guideElement);
                });
            }
            
            console.log('Updated containers:', {
                recommended: recommendedGuides.length,
                notRecommended: notRecommendedGuides.length,
                blocked: blockedGuides.length
            });
        }

        function createGuideElement(guide) {
            const div = document.createElement('div');
            div.className = `guide-item ${guide.status}`;
            
            // Calculate traffic light status
            const trafficLightStatus = calculateTrafficLightStatus(guide);
            const availabilityReasons = getAvailabilityReason(guide);
            
            // Generate constraint tags HTML
            let constraintTagsHtml = '';
            if (availabilityReasons && availabilityReasons.length > 0) {
                constraintTagsHtml = '<div class="constraint-tags">';
                availabilityReasons.forEach(reason => {
                    constraintTagsHtml += `
                        <span class="constraint-tag constraint-${reason.type}">
                            <span class="constraint-icon">${reason.icon}</span>
                            <span class="constraint-text">${reason.text}</span>
                        </span>
                    `;
                });
                constraintTagsHtml += '</div>';
            }
            
            div.innerHTML = `
                <div class="guide-info">
                    <span class="guide-name">${guide.guide_name}</span>
                    <span class="guide-role">${guide.guide_role}</span>
                    <div class="traffic-light">
                        <div class="traffic-light-indicator traffic-light-${trafficLightStatus}"></div>
                        <span>${getTrafficLightText(trafficLightStatus)}</span>
                    </div>
                    ${constraintTagsHtml}
                </div>
                <div class="guide-status">
                    <span class="status-indicator status-${guide.status}"></span>
                    ${getStatusText(guide)}
                </div>
                ${guide.status === 'blocked' ? `
                    <div class="override-toggle">
                        <input type="checkbox" id="override-${guide.guide_id}" onchange="toggleOverride(${guide.guide_id})">
                        <label for="override-${guide.guide_id}">××¤×©×¨ ×¢×§×™×¤×”</label>
                    </div>
                ` : ''}
            `;
            
            // Add click handler based on status
            if (guide.status === 'available') {
                div.onclick = () => selectGuide(div);
            } else if (guide.status === 'blocked') {
                div.onclick = () => selectGuideOverride(div);
            }
            
            return div;
        }

        function calculateTrafficLightStatus(guide) {
            // Check if guide is blocked (has constraints)
            if (guide.status === 'blocked') {
                return 'red'; // ×—×¡×•× - ×œ× ×–××™×Ÿ ×œ×©×™×‘×•×¥
            }
            
            // For available guides, check workload
            if (guide.total_shifts > 12) {
                return 'red'; // ×—×¡×•× - ×¢×•××¡ ×’×‘×•×” ××“×™
            }
            if (guide.total_shifts > 8) {
                return 'yellow'; // ×œ× ××•××œ×¥ - ×¢×•××¡ ×‘×™× ×•× ×™
            }
            
            // Check weekly scheduling rules
            const weeklyStatus = checkWeeklySchedulingRules(guide);
            if (weeklyStatus === 'red') {
                return 'red'; // ×—×¡×•× - ×—×•×§×™ ×©×™×‘×•×¥ ×©×‘×•×¢×™×™×
            }
            if (weeklyStatus === 'yellow') {
                return 'yellow'; // ×œ× ××•××œ×¥ - ×—×•×§×™ ×©×™×‘×•×¥ ×©×‘×•×¢×™×™×
            }
            
            return 'green'; // ××•××œ×¥ - ×–××™×Ÿ ×•×¢×•××¡ × ××•×š
        }
        
        function checkWeeklySchedulingRules(guide) {
            // Check if guide worked recently (within 2 days)
            const recentWorkStatus = checkRecentWork(guide);
            if (recentWorkStatus === 'red') {
                return 'red'; // ×—×¡×•× - ×¢×‘×“ ×œ××—×¨×•× ×”
            }
            if (recentWorkStatus === 'yellow') {
                return 'yellow'; // ×œ× ××•××œ×¥ - ×¢×‘×“ ×œ×¤× ×™ ×™×•××™×™×
            }
            
            return 'green'; // ××•××œ×¥ - ×œ× ×¢×‘×“ ×œ××—×¨×•× ×”
        }
        
        function checkRecentWork(guide) {
            if (!currentDate) return 'green';
            
            const currentDateObj = new Date(currentDate);
            const guideId = guide.guide_id;
            
            // Check if guide worked yesterday (day -1)
            const yesterday = new Date(currentDateObj);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            // Check if guide worked day before yesterday (day -2)
            const dayBeforeYesterday = new Date(currentDateObj);
            dayBeforeYesterday.setDate(dayBeforeYesterday.getDate() - 2);
            const dayBeforeYesterdayStr = dayBeforeYesterday.toISOString().split('T')[0];
            
            // Check if guide worked tomorrow (day +1)
            const tomorrow = new Date(currentDateObj);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            // Check if guide worked day after tomorrow (day +2)
            const dayAfterTomorrow = new Date(currentDateObj);
            dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);
            const dayAfterTomorrowStr = dayAfterTomorrow.toISOString().split('T')[0];
            
            // Check current month schedule for these dates
            const [year, month] = currentMonth.split('-');
            const monthSchedule = getCurrentMonthSchedule();
            
            if (!monthSchedule) return 'green';
            
            // Check if guide worked yesterday or tomorrow (red - too close)
            const workedYesterday = monthSchedule.some(day => 
                day.date === yesterdayStr && (day.guide1_id === guideId || day.guide2_id === guideId)
            );
            const workedTomorrow = monthSchedule.some(day => 
                day.date === tomorrowStr && (day.guide1_id === guideId || day.guide2_id === guideId)
            );
            
            if (workedYesterday || workedTomorrow) {
                return 'red'; // ×—×¡×•× - ×¢×‘×“ ××ª××•×œ ××• ×¢×•×‘×“ ××—×¨
            }
            
            // Check if guide worked day before yesterday or day after tomorrow (yellow - 2 days gap)
            const workedDayBeforeYesterday = monthSchedule.some(day => 
                day.date === dayBeforeYesterdayStr && (day.guide1_id === guideId || day.guide2_id === guideId)
            );
            const workedDayAfterTomorrow = monthSchedule.some(day => 
                day.date === dayAfterTomorrowStr && (day.guide1_id === guideId || day.guide2_id === guideId)
            );
            
            if (workedDayBeforeYesterday || workedDayAfterTomorrow) {
                return 'yellow'; // ×œ× ××•××œ×¥ - ×¢×‘×“ ×œ×¤× ×™ ×™×•××™×™× ××• ×¢×•×‘×“ ×‘×¢×•×“ ×™×•××™×™×
            }
            
            return 'green'; // ××•××œ×¥ - ×”×¤×¨×© ×©×œ ×œ×¤×—×•×ª 3 ×™××™×
        }
        
        function getCurrentMonthSchedule() {
            // This should return the current month's schedule data
            // For now, we'll use a simple approach - in a real implementation,
            // this would be cached or fetched from the current month data
            return window.currentMonthSchedule || [];
        }
        
        function getTrafficLightText(status) {
            switch(status) {
                case 'green': return '××•××œ×¥';
                case 'yellow': return '×œ× ××•××œ×¥';
                case 'red': return '×—×¡×•×';
                default: return '×œ× ×™×“×•×¢';
            }
        }
        
        function getAvailabilityReason(guide) {
            if (guide.status === 'blocked') {
                const reasons = [];
                
                // Check for vacation
                if (guide.vacation_id) {
                    reasons.push({
                        type: 'vacation',
                        text: '×—×•×¤×©×”',
                        icon: 'ğŸ–ï¸'
                    });
                }
                
                // Check for personal constraint (one-time)
                if (guide.constraint_id) {
                    reasons.push({
                        type: 'constraint',
                        text: '×—×“ ×¤×¢××™',
                        icon: 'ğŸš«'
                    });
                }
                
                // Check for fixed constraint (recurring)
                if (guide.fixed_constraint_id) {
                    reasons.push({
                        type: 'fixed_constraint',
                        text: '×§×‘×•×¢',
                        icon: 'ğŸ“…'
                    });
                }
                
                // Check for consecutive days
                if (guide.consecutive_prev_id) {
                    reasons.push({
                        type: 'consecutive',
                        text: '×¦××™×“×•×ª',
                        icon: 'ğŸ”„'
                    });
                }
                
                if (guide.consecutive_next_id) {
                    reasons.push({
                        type: 'consecutive',
                        text: '×¦××™×“×•×ª',
                        icon: 'ğŸ”„'
                    });
                }
                
                // Check for coordinator rules
                            if (guide.coordinator_rule_no_auto_id) {
                reasons.push({
                    type: 'info',
                    text: '×œ× ×‘××•×˜×•××˜×™',
                    icon: 'ğŸ¤–'
                });
            }
                
                if (guide.coordinator_rule_no_conan_id) {
                    reasons.push({
                        type: 'coordinator_rule',
                        text: '×œ× ×›×›×•× ×Ÿ',
                        icon: 'ğŸš«'
                    });
                }
                
                // If no specific constraint type, show generic blocked
                if (reasons.length === 0) {
                    reasons.push({
                        type: 'blocked',
                        text: '×—×¡×•×',
                        icon: 'ğŸš«'
                    });
                }
                
                return reasons;
            }
            
            // For available guides, check weekly rules first
            const weeklyReasons = getWeeklyRuleReasons(guide);
            if (weeklyReasons && weeklyReasons.length > 0) {
                return weeklyReasons;
            }
            
            // Show workload warnings if no weekly rules
            if (guide.total_shifts > 12) {
                return [{
                    type: 'workload_high',
                    text: `×¢×•××¡ ×’×‘×•×”: ${guide.total_shifts} ××©××¨×•×ª ×”×—×•×“×©`,
                    icon: 'âš ï¸'
                }];
            }
            if (guide.total_shifts > 8) {
                return [{
                    type: 'workload_medium',
                    text: `×¢×•××¡ ×‘×™× ×•× ×™: ${guide.total_shifts} ××©××¨×•×ª ×”×—×•×“×©`,
                    icon: 'âš–ï¸'
                }];
            }
            
            return null;
        }
        
        function getWeeklyRuleReasons(guide) {
            if (!currentDate) return null;
            
            const currentDateObj = new Date(currentDate);
            const guideId = guide.guide_id;
            const monthSchedule = getCurrentMonthSchedule();
            
            if (!monthSchedule) return null;
            
            const reasons = [];
            
            // Check if guide worked yesterday or tomorrow (red - too close)
            const yesterday = new Date(currentDateObj);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            const tomorrow = new Date(currentDateObj);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            const workedYesterday = monthSchedule.some(day => 
                day.date === yesterdayStr && (day.guide1_id === guideId || day.guide2_id === guideId)
            );
            const workedTomorrow = monthSchedule.some(day => 
                day.date === tomorrowStr && (day.guide1_id === guideId || day.guide2_id === guideId)
            );
            
            if (workedYesterday) {
                reasons.push({
                    type: 'weekly_rule',
                    text: '×¢×‘×“ ××ª××•×œ',
                    icon: 'ğŸ”„'
                });
            }
            
            if (workedTomorrow) {
                reasons.push({
                    type: 'weekly_rule',
                    text: '×¢×•×‘×“ ××—×¨',
                    icon: 'ğŸ”„'
                });
            }
            
            // Check if guide worked day before yesterday or day after tomorrow (yellow - 2 days gap)
            const dayBeforeYesterday = new Date(currentDateObj);
            dayBeforeYesterday.setDate(dayBeforeYesterday.getDate() - 2);
            const dayBeforeYesterdayStr = dayBeforeYesterday.toISOString().split('T')[0];
            
            const dayAfterTomorrow = new Date(currentDateObj);
            dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);
            const dayAfterTomorrowStr = dayAfterTomorrow.toISOString().split('T')[0];
            
            const workedDayBeforeYesterday = monthSchedule.some(day => 
                day.date === dayBeforeYesterdayStr && (day.guide1_id === guideId || day.guide2_id === guideId)
            );
            const workedDayAfterTomorrow = monthSchedule.some(day => 
                day.date === dayAfterTomorrowStr && (day.guide1_id === guideId || day.guide2_id === guideId)
            );
            
            if (workedDayBeforeYesterday) {
                reasons.push({
                    type: 'weekly_rule',
                    text: '×¢×‘×“ ×œ×¤× ×™ ×™×•××™×™×',
                    icon: 'âš ï¸'
                });
            }
            
            if (workedDayAfterTomorrow) {
                reasons.push({
                    type: 'weekly_rule',
                    text: '×¢×•×‘×“ ×‘×¢×•×“ ×™×•××™×™×',
                    icon: 'âš ï¸'
                });
            }
            
            return reasons.length > 0 ? reasons : null;
        }
        
        function getStatusText(guide) {
            switch (guide.status) {
                case 'available':
                    return '×–××™×Ÿ';
                case 'blocked':
                    return guide.reason || '×—×¡×•×';
                case 'warning':
                    return guide.reason || '××–×”×¨×”';
                default:
                    return '×œ× ×™×“×•×¢';
            }
        }
        
        function toggleOverride(guideId) {
            const checkbox = document.getElementById(`override-${guideId}`);
            const guideElement = checkbox.closest('.guide-item');
            
            if (checkbox.checked) {
                guideElement.classList.remove('blocked');
                guideElement.classList.add('blocked-override');
                guideElement.onclick = () => selectGuide(guideElement);
            } else {
                guideElement.classList.remove('blocked-override');
                guideElement.classList.add('blocked');
                guideElement.onclick = null;
            }
            
            console.log(`Override ${checkbox.checked ? 'enabled' : 'disabled'} for guide ${guideId}`);
        }

        // =====================================================
        // EVENT HANDLERS
        // =====================================================

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing Sigalit Scheduler...');
            
            // Load initial data
            await Promise.all([
                fetchGuides(),
                fetchAssignmentTypes(),
                fetchShiftTypes()
            ]);
            
            // Load current month schedule
            const [year, month] = currentMonth.split('-');
            await loadMonthSchedule(year, month);
            
            // Set up event listeners
            setupEventListeners();
        });

        function setupEventListeners() {
            // Month selector
            document.getElementById('month-select').addEventListener('change', async function() {
                currentMonth = this.value;
                const [year, month] = currentMonth.split('-');
                await loadMonthSchedule(year, month);
            });

            // Toolbar buttons
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('click', handleToolbarButton);
            });

            // Side panel close
            document.getElementById('side-panel-close').addEventListener('click', closeSidePanel);
            document.getElementById('side-panel-overlay').addEventListener('click', closeSidePanel);

            // Override toggle
            document.getElementById('manual-override').addEventListener('change', function() {
                toggleOverrideMode(this.checked);
            });
        }

        async function loadMonthSchedule(year, month) {
            try {
                showNotification('×˜×•×¢×Ÿ ×œ×•×— ×©× ×”...', 'info');
                const schedule = await fetchMonthlySchedule(year, month);
                if (schedule) {
                    updateCalendarWithSchedule(schedule);
                    // Load weekend types after calendar is updated
                    await loadWeekendTypes(year, month);
                    showNotification('×œ×•×— ×”×©× ×” × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”', 'success');
                }
            } catch (error) {
                console.error('Error loading month schedule:', error);
                showNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ×œ×•×— ×”×©× ×”', 'error');
            }
            
            // ADD THIS LINE AT THE END:
            const monthStr = `${year}-${String(month).padStart(2, '0')}`;
            await loadWorkflowStatus(monthStr);
        }

        function handleToolbarButton(event) {
            const buttonText = event.target.textContent.trim();
            
            switch (buttonText) {
                case '×©×‘×¥ ××•×˜×•××˜×™×ª':
                    runAutoScheduling();
                    break;
                case '×©××•×¨':
                    saveCurrentDraft();
                    break;
                case '×˜×¢×Ÿ':
                    loadDraft();
                    break;
                case '××—×§':
                    deleteDraft();
                    break;
                case '× ×§×” ×”×›×œ':
                    console.log('× ×§×” ×”×›×œ button clicked!');
                    clearAllAssignments();
                    break;
                case '×™×™×¦× ×œ××§×¡×œ':
                    exportToExcel();
                    break;
                default:
                    console.log('Button clicked:', buttonText);
            }
        }

        function editDay(date) {
            console.log('editDay called with date:', date);
            currentDate = date;
            loadDayAvailability(date);
            loadCurrentAssignments(date);
            openSidePanel();
        }

        async function loadDayAvailability(date) {
            try {
                console.log('Loading availability for date:', date);
                const availability = await fetchGuideAvailability(date);
                console.log('Received availability data:', availability);
                
                // Load current month schedule for weekly rules
                const [year, month] = currentMonth.split('-');
                const monthSchedule = await fetchMonthlySchedule(year, month);
                window.currentMonthSchedule = monthSchedule; // Cache for weekly rules
                
                if (availability) {
                    updateSidePanelWithAvailability(availability);
                    updateSidePanelDate(date);
                }
            } catch (error) {
                console.error('Error loading day availability:', error);
                showNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ×–××™× ×•×ª', 'error');
            }
        }
        
        async function loadCurrentAssignments(date) {
            try {
                const schedule = await fetchMonthlySchedule(new Date(date).getFullYear(), String(new Date(date).getMonth() + 1).padStart(2, '0'));
                const dayAssignment = schedule.find(day => day.date === date);
                
                if (dayAssignment) {
                    updateSelectedGuidesDisplay(dayAssignment);
                } else {
                    clearSelectedGuidesDisplay();
                }
            } catch (error) {
                console.error('Error loading current assignments:', error);
            }
        }
        
        function updateSelectedGuidesDisplay(assignment) {
            const container = document.querySelector('.selected-guides-container');
            container.innerHTML = '';
            
            if (assignment.guide1_name) {
                container.innerHTML += `
                    <div class="selected-guide-item">
                        <div class="guide-info">
                            <span class="guide-name">${assignment.guide1_name}</span>
                            <span class="guide-role">${assignment.guide1_role}</span>
                            ${assignment.is_manual ? '<span class="manual-badge">ğŸ”’ ×™×“× ×™</span>' : '<span class="auto-badge">ğŸ¤– ××•×˜×•××˜×™</span>'}
                        </div>
                        <button class="remove-guide-btn" onclick="removeGuide('${assignment.guide1_id}')">Ã—</button>
                    </div>
                `;
            }
            
            if (assignment.guide2_name) {
                container.innerHTML += `
                    <div class="selected-guide-item">
                        <div class="guide-info">
                            <span class="guide-name">${assignment.guide2_name}</span>
                            <span class="guide-role">${assignment.guide2_role}</span>
                            ${assignment.is_manual ? '<span class="manual-badge">ğŸ”’ ×™×“× ×™</span>' : '<span class="auto-badge">ğŸ¤– ××•×˜×•××˜×™</span>'}
                        </div>
                        <button class="remove-guide-btn" onclick="removeGuide('${assignment.guide2_id}')">Ã—</button>
                    </div>
                `;
            }
            
            updateAssignmentStatus();
        }
        
        function updateSelectedGuidesFromArray() {
            const container = document.querySelector('.selected-guides-container');
            container.innerHTML = '';
            
            if (selectedGuides.length === 0) {
                container.innerHTML = '<div class="no-assignments">××™×Ÿ ×©×™×‘×•×¦×™× ×œ×™×•× ×–×”</div>';
            } else {
                selectedGuides.forEach((guideName, index) => {
                    container.innerHTML += `
                        <div class="selected-guide-item">
                            <div class="guide-info">
                                <span class="guide-name">${guideName}</span>
                                <span class="guide-role">××“×¨×™×š</span>
                                <span class="manual-badge">ğŸ”’ ×™×“× ×™</span>
                            </div>
                            <button class="remove-guide-btn" onclick="removeGuideByName('${guideName}')">Ã—</button>
                        </div>
                    `;
                });
            }
            
            updateAssignmentStatus();
        }
        
        function clearSelectedGuidesDisplay() {
            const container = document.querySelector('.selected-guides-container');
            container.innerHTML = '<div class="no-assignments">××™×Ÿ ×©×™×‘×•×¦×™× ×œ×™×•× ×–×”</div>';
            updateAssignmentStatus();
        }
        
        function updateAssignmentStatus() {
            const container = document.querySelector('.selected-guides-container');
            const count = container.querySelectorAll('.selected-guide-item').length;
            const statusElement = document.querySelector('.assignment-status');
            
            if (count === 0) {
                statusElement.innerHTML = '<span class="status-badge status-empty">××™×Ÿ ×©×™×‘×•×¦×™×</span>';
            } else if (count === 1) {
                statusElement.innerHTML = '<span class="status-badge status-partial">×©×™×‘×•×¥ ×—×œ×§×™ (1/2)</span>';
            } else {
                statusElement.innerHTML = '<span class="status-badge status-complete">×©×™×‘×•×¥ ××œ× (2/2)</span>';
            }
        }

        function updateSidePanelDate(date) {
            const dateElement = document.querySelector('.side-panel-date');
            if (dateElement) {
                const hebrewDate = new Date(date).toLocaleDateString('he-IL');
                dateElement.textContent = hebrewDate;
            }
        }

        // =====================================================
        // SIDE PANEL FUNCTIONS
        // =====================================================

        function openSidePanel() {
            document.getElementById('side-panel-overlay').style.display = 'block';
            document.getElementById('side-panel').classList.add('open');
            document.body.style.overflow = 'hidden';
            sidePanelOpen = true;
        }

        function closeSidePanel() {
            document.getElementById('side-panel').classList.remove('open');
            setTimeout(() => {
                document.getElementById('side-panel-overlay').style.display = 'none';
                document.body.style.overflow = 'auto';
            }, 300);
            sidePanelOpen = false;
            selectedGuides = [];
        }

        function selectGuide(element) {
            element.classList.toggle('selected');
            const guideName = element.querySelector('.guide-name').textContent;
            
            if (element.classList.contains('selected')) {
                selectedGuides.push(guideName);
            } else {
                selectedGuides = selectedGuides.filter(name => name !== guideName);
            }
            
            console.log('Selected guides:', selectedGuides);
            
            // Update the selected guides display
            updateSelectedGuidesFromArray();
            
            // Refresh availability list to hide/show selected guides
            if (currentDate) {
                loadDayAvailability(currentDate);
            }
        }

        function selectGuideOverride(element) {
            const overrideEnabled = document.getElementById('manual-override').checked;
            if (overrideEnabled) {
                element.classList.toggle('selected');
                const guideName = element.querySelector('.guide-name').textContent;
                
                if (element.classList.contains('selected')) {
                    selectedGuides.push(guideName);
                } else {
                    selectedGuides = selectedGuides.filter(name => name !== guideName);
                }
                
                console.log('Guide selected with override:', guideName);
                
                // Update the selected guides display
                updateSelectedGuidesFromArray();
                
                // Refresh availability list to hide/show selected guides
                if (currentDate) {
                    loadDayAvailability(currentDate);
                }
            } else {
                showNotification('×™×© ×œ×”×¤×¢×™×œ Manual Override ×›×“×™ ×œ×©×‘×¥ ××“×¨×™×š ×—×¡×•×', 'warning');
            }
        }

        function toggleOverrideMode(enabled) {
            const blockedOverrideItems = document.querySelectorAll('.guide-item.blocked-override');
            blockedOverrideItems.forEach(item => {
                if (enabled) {
                    item.style.cursor = 'pointer';
                    item.style.opacity = '1';
                } else {
                    item.style.cursor = 'not-allowed';
                    item.style.opacity = '0.7';
                    item.classList.remove('selected');
                }
            });
        }

        async function saveChanges() {
            if (!currentDate) {
                showNotification('××™×Ÿ ×ª××¨×™×š × ×‘×—×¨', 'warning');
                return;
            }

            try {
                let guide1 = null;
                let guide2 = null;
                let assignmentType = '×¨×’×™×œ';
                
                // Check day type and determine assignment rules
                const dayOfWeek = new Date(currentDate).getDay();
                const isSaturday = dayOfWeek === 6;
                const isFriday = dayOfWeek === 5;
                const isSunday = dayOfWeek === 0;
                
                if (isSaturday) {
                    // Check if this is a closed Saturday
                    const fridayDate = new Date(currentDate);
                    fridayDate.setDate(fridayDate.getDate() - 1);
                    const fridayString = fridayDate.toISOString().split('T')[0];
                    
                    try {
                        const response = await fetch(`${API_BASE}/weekend-type/${fridayString}`);
                        const result = await response.json();
                        
                        if (result.is_closed === 1) {
                            // Closed Saturday - can have 1 additional guide (××•×¦×´×©) in addition to the conan from Friday
                            if (selectedGuides.length === 0) {
                                showNotification('×©×‘×ª ×¡×’×•×¨×” ×“×•×¨×©×ª ×œ×¤×—×•×ª ××“×¨×™×š × ×•×¡×£ ××—×“ (××•×¦×´×©)', 'warning');
                                return;
                            }
                            if (selectedGuides.length > 1) {
                                showNotification('×©×‘×ª ×¡×’×•×¨×” ×™×›×•×œ×” ×œ×§×‘×œ ××“×¨×™×š × ×•×¡×£ ××—×“ ×‘×œ×‘×“ (××•×¦×´×©)', 'warning');
                                return;
                            }
                            assignmentType = '××•×¦×´×©';
                                        } else {
                    // Open Saturday - can have 1 or 2 guides (auto will complete)
                    if (selectedGuides.length > 2) {
                        showNotification('×œ× × ×™×ª×Ÿ ×œ×©×‘×¥ ×™×•×ª×¨ ×-2 ××“×¨×™×›×™× ×‘×©×‘×ª', 'warning');
                        return;
                    }
                    if (selectedGuides.length === 2) {
                        assignmentType = '×—×¤×™×¤×”';
                    } else {
                        assignmentType = '×¨×’×™×œ';
                    }
                }
                    } catch (error) {
                        console.error('Error checking weekend type:', error);
                        // Default to open Saturday if we can't check
                        if (selectedGuides.length > 2) {
                            showNotification('×œ× × ×™×ª×Ÿ ×œ×©×‘×¥ ×™×•×ª×¨ ×-2 ××“×¨×™×›×™× ×‘×©×‘×ª', 'warning');
                            return;
                        }
                        if (selectedGuides.length === 2) {
                            assignmentType = '×—×¤×™×¤×”';
                        } else {
                            assignmentType = '×¨×’×™×œ';
                        }
                    }
                } else if (isFriday) {
                    // Check if this Friday is for a closed Saturday
                    try {
                        const response = await fetch(`${API_BASE}/weekend-type/${currentDate}`);
                        const result = await response.json();
                        
                        if (result.is_closed === 1) {
                            // Closed Saturday Friday - requires exactly 1 guide (×›×•× ×Ÿ)
                            if (selectedGuides.length !== 1) {
                                showNotification('×©×™×©×™ ×œ×©×‘×ª ×¡×’×•×¨×” ×“×•×¨×© ×›×•× ×Ÿ ××—×“ ×‘×œ×‘×“', 'warning');
                                return;
                            }
                            assignmentType = '×›×•× ×Ÿ';
                        } else {
                            // Regular Friday - can have 1 or 2 guides (auto will complete)
                            if (selectedGuides.length > 2) {
                                showNotification('×œ× × ×™×ª×Ÿ ×œ×©×‘×¥ ×™×•×ª×¨ ×-2 ××“×¨×™×›×™× ×‘×™×•× ×—×•×œ', 'warning');
                                return;
                            }
                            if (selectedGuides.length === 2) {
                                assignmentType = '×—×¤×™×¤×”';
                            } else {
                                assignmentType = '×¨×’×™×œ';
                            }
                        }
                    } catch (error) {
                        console.error('Error checking weekend type:', error);
                        // Default to regular Friday
                        if (selectedGuides.length > 2) {
                            showNotification('×œ× × ×™×ª×Ÿ ×œ×©×‘×¥ ×™×•×ª×¨ ×-2 ××“×¨×™×›×™× ×‘×™×•× ×—×•×œ', 'warning');
                            return;
                        }
                        if (selectedGuides.length === 2) {
                            assignmentType = '×—×¤×™×¤×”';
                        } else {
                            assignmentType = '×¨×’×™×œ';
                        }
                    }
                } else {
                    // Regular weekday (Sunday-Thursday) - can have 1 or 2 guides (auto will complete)
                    if (selectedGuides.length > 2) {
                        showNotification('×œ× × ×™×ª×Ÿ ×œ×©×‘×¥ ×™×•×ª×¨ ×-2 ××“×¨×™×›×™× ×‘×™×•× ×—×•×œ', 'warning');
                        return;
                    }
                    if (selectedGuides.length === 2) {
                        assignmentType = '×—×¤×™×¤×”';
                    } else {
                        assignmentType = '×¨×’×™×œ';
                    }
                }
                
                if (selectedGuides.length > 0) {
                    console.log('Selected guides:', selectedGuides);
                    console.log('Available guides data:', guidesData.map(g => ({ id: g.id, name: g.name })));
                    
                    guide1 = guidesData.find(g => g.name === selectedGuides[0]);
                    guide2 = selectedGuides[1] ? guidesData.find(g => g.name === selectedGuides[1]) : null;
                    
                    console.log('Found guide1:', guide1);
                    console.log('Found guide2:', guide2);
                }
                
                const success = await saveManualAssignment(
                    currentDate,
                    guide1?.id,
                    guide2?.id,
                    assignmentType
                );
                
                if (success) {
                    console.log('Manual assignment saved successfully');
                    console.log('isFriday:', isFriday, 'assignmentType:', assignmentType, 'guide1?.id:', guide1?.id);
                    
                    // If this is a Friday with closed Saturday and we assigned a conan,
                    // automatically assign the same guide to Saturday as well
                    if (isFriday && assignmentType === '×›×•× ×Ÿ' && guide1?.id) {
                        console.log('Attempting to auto-assign conan to Saturday...');
                        try {
                            const response = await fetch(`${API_BASE}/weekend-type/${currentDate}`);
                            const result = await response.json();
                            console.log('Weekend type check result:', result);
                            
                            if (result.is_closed === 1) {
                                console.log('This is a closed Saturday Friday, auto-assigning conan to Saturday');
                                // This is a closed Saturday Friday, automatically assign the conan to Saturday
                                const saturdayDate = new Date(currentDate);
                                saturdayDate.setDate(saturdayDate.getDate() + 1);
                                const saturdayString = saturdayDate.toISOString().split('T')[0];
                                console.log('Saturday date:', saturdayString);
                                
                                // For closed Saturday, we only register the conan guide from Friday
                                // The conan guide will be available for Saturday until 17:00
                                // Additional guide for Saturday will be assigned separately
                                
                                // Save Saturday assignment with only the conan guide (no second guide yet)
                                console.log('Saving conan to Saturday:', saturdayString, guide1.id, '×›×•× ×Ÿ');
                                const saturdayResponse = await saveManualAssignment(saturdayString, guide1.id, null, '×›×•× ×Ÿ');
                                console.log('Saturday assignment response:', saturdayResponse);
                                
                                if (saturdayResponse) {
                                    showNotification('×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×” - ×”×›×•× ×Ÿ × ×¨×©× ××•×˜×•××˜×™×ª ×œ×©×‘×ª ×¢×“ 17:00', 'success');
                                } else {
                                    showNotification('×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”, ××š ×”×™×™×ª×” ×©×’×™××” ×‘×¨×™×©×•× ×”×›×•× ×Ÿ ×œ×©×‘×ª', 'warning');
                                }
                            } else {
                                console.log('This is not a closed Saturday Friday');
                                const guideCount = selectedGuides.length;
                                const message = guideCount === 1 
                                    ? '×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×” - ×”×©×™×‘×•×¥ ×”××•×˜×•××˜×™ ×™×©×œ×™× ××ª ×”×™×•×'
                                    : '×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”';
                                showNotification(message, 'success');
                            }
                        } catch (error) {
                            console.error('Error auto-assigning conan to Saturday:', error);
                            const guideCount = selectedGuides.length;
                            const message = guideCount === 1 
                                ? '×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×” - ×”×©×™×‘×•×¥ ×”××•×˜×•××˜×™ ×™×©×œ×™× ××ª ×”×™×•×'
                                : '×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”';
                            showNotification(message, 'success');
                        }
                    } else if (isSaturday && selectedGuides.length === 0) {
                        // If we're clearing Saturday assignments, check if we need to remove conan from Friday too
                        console.log('Clearing Saturday assignments, checking if conan needs to be removed from Friday');
                        try {
                            const fridayDate = new Date(currentDate);
                            fridayDate.setDate(fridayDate.getDate() - 1);
                            const fridayString = fridayDate.toISOString().split('T')[0];
                            
                            const response = await fetch(`${API_BASE}/weekend-type/${fridayString}`);
                            const result = await response.json();
                            
                            if (result.is_closed === 1) {
                                // This is a closed Saturday, check if Friday has a conan
                                const fridaySchedule = window.currentMonthSchedule?.find(d => d.date === fridayString);
                                if (fridaySchedule && fridaySchedule.guide1_role === '×›×•× ×Ÿ') {
                                    console.log('Removing conan from Friday as well');
                                    await removeConanFromWeekend(fridayString, fridaySchedule.guide1_id);
                                    showNotification('×”×›×•× ×Ÿ ×”×•×¡×¨ ×’× ××”×©×™×©×™ ×•×’× ××”×©×‘×ª', 'success');
                                } else {
                                    const guideCount = selectedGuides.length;
                                    const message = guideCount === 1 
                                        ? '×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×” - ×”×©×™×‘×•×¥ ×”××•×˜×•××˜×™ ×™×©×œ×™× ××ª ×”×™×•×'
                                        : '×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”';
                                    showNotification(message, 'success');
                                }
                            } else {
                                const guideCount = selectedGuides.length;
                                const message = guideCount === 1 
                                    ? '×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×” - ×”×©×™×‘×•×¥ ×”××•×˜×•××˜×™ ×™×©×œ×™× ××ª ×”×™×•×'
                                    : '×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”';
                                showNotification(message, 'success');
                            }
                        } catch (error) {
                            console.error('Error checking Friday conan removal:', error);
                            const guideCount = selectedGuides.length;
                            const message = guideCount === 1 
                                ? '×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×” - ×”×©×™×‘×•×¥ ×”××•×˜×•××˜×™ ×™×©×œ×™× ××ª ×”×™×•×'
                                : '×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”';
                            showNotification(message, 'success');
                        }
                    } else if (isSaturday && assignmentType === '××•×¦×´×©' && guide1?.id) {
                        // If we're adding a ××•×¦×´×© guide to Saturday, make sure the conan from Friday is preserved
                        console.log('Adding ××•×¦×´×© guide to Saturday, ensuring conan from Friday is preserved');
                        try {
                            const fridayDate = new Date(currentDate);
                            fridayDate.setDate(fridayDate.getDate() - 1);
                            const fridayString = fridayDate.toISOString().split('T')[0];
                            
                            const response = await fetch(`${API_BASE}/weekend-type/${fridayString}`);
                            const result = await response.json();
                            
                            if (result.is_closed === 1) {
                                // This is a closed Saturday, check if Friday has a conan
                                const fridaySchedule = window.currentMonthSchedule?.find(d => d.date === fridayString);
                                if (fridaySchedule && fridaySchedule.guide1_role === '×›×•× ×Ÿ') {
                                    console.log('Conan from Friday is preserved, adding ××•×¦×´×© guide');
                                    showNotification('×”×›×•× ×Ÿ × ×©××¨ ××”×©×™×©×™, ××“×¨×™×š ××•×¦×´×© × ×•×¡×£ ×‘×”×¦×œ×—×”', 'success');
                                } else {
                                    console.log('No conan found on Friday, this might be an error');
                                    showNotification('×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”', 'success');
                                }
                            } else {
                                showNotification('×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”', 'success');
                            }
                        } catch (error) {
                            console.error('Error checking Friday conan preservation:', error);
                            showNotification('×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”', 'success');
                        }
                    } else if (isSaturday && selectedGuides.length === 0) {
                        // If we're clearing Saturday assignments, check if we need to remove conan from Friday too
                        console.log('Clearing Saturday assignments, checking if conan needs to be removed from Friday');
                        try {
                            const fridayDate = new Date(currentDate);
                            fridayDate.setDate(fridayDate.getDate() - 1);
                            const fridayString = fridayDate.toISOString().split('T')[0];
                            
                            const response = await fetch(`${API_BASE}/weekend-type/${fridayString}`);
                            const result = await response.json();
                            
                            if (result.is_closed === 1) {
                                // This is a closed Saturday, check if Friday has a conan
                                const fridaySchedule = window.currentMonthSchedule?.find(d => d.date === fridayString);
                                if (fridaySchedule && fridaySchedule.guide1_role === '×›×•× ×Ÿ') {
                                    console.log('Removing conan from Friday as well');
                                    await removeConanFromWeekend(fridayString, fridaySchedule.guide1_id);
                                    showNotification('×”×›×•× ×Ÿ ×”×•×¡×¨ ×’× ××”×©×™×©×™ ×•×’× ××”×©×‘×ª', 'success');
                                } else {
                                    const guideCount = selectedGuides.length;
                                    const message = guideCount === 1 
                                        ? '×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×” - ×”×©×™×‘×•×¥ ×”××•×˜×•××˜×™ ×™×©×œ×™× ××ª ×”×™×•×'
                                        : '×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”';
                                    showNotification(message, 'success');
                                }
                            } else {
                                const guideCount = selectedGuides.length;
                                const message = guideCount === 1 
                                    ? '×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×” - ×”×©×™×‘×•×¥ ×”××•×˜×•××˜×™ ×™×©×œ×™× ××ª ×”×™×•×'
                                    : '×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”';
                                showNotification(message, 'success');
                            }
                        } catch (error) {
                            console.error('Error checking Friday conan removal:', error);
                            const guideCount = selectedGuides.length;
                            const message = guideCount === 1 
                                ? '×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×” - ×”×©×™×‘×•×¥ ×”××•×˜×•××˜×™ ×™×©×œ×™× ××ª ×”×™×•×'
                                : '×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”';
                            showNotification(message, 'success');
                        }
                    } else {
                        console.log('Not a Friday conan assignment or missing conditions');
                        const guideCount = selectedGuides.length;
                        const message = guideCount === 1 
                            ? '×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×” - ×”×©×™×‘×•×¥ ×”××•×˜×•××˜×™ ×™×©×œ×™× ××ª ×”×™×•×'
                            : '×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”';
                        showNotification(message, 'success');
                    }
                    
                    closeSidePanel();
                    // Reload the month schedule to show changes
                    const [year, month] = currentMonth.split('-');
                    await loadMonthSchedule(year, month);
                }
            } catch (error) {
                console.error('Error saving changes:', error);
                showNotification('×©×’×™××” ×‘×©××™×¨×ª ×”×©×™× ×•×™×™×', 'error');
            }
        }
        
        function removeGuide(guideId) {
            const container = document.querySelector('.selected-guides-container');
            const guideItem = container.querySelector(`[onclick*="${guideId}"]`).closest('.selected-guide-item');
            if (guideItem) {
                const guideName = guideItem.querySelector('.guide-name').textContent;
                guideItem.remove();
                
                // Remove from selectedGuides array
                selectedGuides = selectedGuides.filter(name => name !== guideName);
                
                updateAssignmentStatus();
                
                // Refresh availability list to show the removed guide again
                if (currentDate) {
                    loadDayAvailability(currentDate);
                }
            }
        }
        
        function removeGuideByName(guideName) {
            // Remove from selectedGuides array
            selectedGuides = selectedGuides.filter(name => name !== guideName);
            
            // Update the display
            updateSelectedGuidesFromArray();
            
            // Refresh availability list to show the removed guide again
            if (currentDate) {
                loadDayAvailability(currentDate);
            }
        }
        
        // Function to remove conan guide from both Friday and Saturday
        async function removeConanFromWeekend(fridayDate, guideId) {
            try {
                console.log('Removing conan guide from weekend:', fridayDate, guideId);
                
                // Remove from Friday
                await saveManualAssignment(fridayDate, null, null, null);
                
                // Remove from Saturday
                const saturdayDate = new Date(fridayDate);
                saturdayDate.setDate(saturdayDate.getDate() + 1);
                const saturdayString = saturdayDate.toISOString().split('T')[0];
                await saveManualAssignment(saturdayString, null, null, null);
                
                console.log('Conan guide removed from both Friday and Saturday');
                
                // Reload the month schedule to show changes
                const [year, month] = currentMonth.split('-');
                await loadMonthSchedule(year, month);
                
            } catch (error) {
                console.error('Error removing conan from weekend:', error);
                showNotification('×©×’×™××” ×‘×”×¡×¨×ª ×”×›×•× ×Ÿ ××¡×•×£ ×”×©×‘×•×¢', 'error');
            }
        }

        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Calculate position based on existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            const topOffset = 20 + (existingNotifications.length * 70); // 70px spacing between notifications
            
            // Add styles
            notification.style.cssText = `
                position: fixed;
                top: ${topOffset}px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                max-width: 400px;
                word-wrap: break-word;
            `;
            
            // Set background color based on type
            switch (type) {
                case 'success':
                    notification.style.backgroundColor = '#10b981';
                    break;
                case 'error':
                    notification.style.backgroundColor = '#ef4444';
                    break;
                case 'warning':
                    notification.style.backgroundColor = '#f59e0b';
                    break;
                default:
                    notification.style.backgroundColor = '#3b82f6';
            }
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Weekend type management
        async function toggleWeekendType(date, isClosed) {
            try {
                const response = await fetch(`${API_BASE}/weekend-type/${date}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ is_closed: isClosed })
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification(isClosed ? '×©×‘×ª ×¡×’×•×¨×” × ×§×‘×¢×”' : '×©×‘×ª ×¤×ª×•×—×” × ×§×‘×¢×”', 'success');
                    // Reload the month to update availability
                    const [year, month] = currentMonth.split('-');
                    await loadMonthSchedule(year, month);
                } else {
                    showNotification('×©×’×™××” ×‘×§×‘×™×¢×ª ×¡×•×’ ×”×©×‘×ª', 'error');
                }
            } catch (error) {
                console.error('Error toggling weekend type:', error);
                showNotification('×©×’×™××” ×‘×§×‘×™×¢×ª ×¡×•×’ ×”×©×‘×ª', 'error');
            }
        }

        // Load weekend types for the month
        async function loadWeekendTypes(year, month) {
            try {
                const startDate = `${year}-${String(month).padStart(2, '0')}-01`;
                const endDate = `${year}-${String(month).padStart(2, '0')}-31`;
                
                // Load weekend types for all Fridays in the month
                const fridays = getFridaysInMonth(year, month);
                for (const friday of fridays) {
                    const response = await fetch(`${API_BASE}/weekend-type/${friday}`);
                    const result = await response.json();
                    
                    // Update checkbox state
                    const checkbox = document.querySelector(`input[data-date="${friday}"]`);
                    if (checkbox) {
                        checkbox.checked = result.is_closed === 1;
                    }
                }
            } catch (error) {
                console.error('Error loading weekend types:', error);
            }
        }

        function getFridaysInMonth(year, month) {
            const fridays = [];
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month - 1, day);
                if (date.getDay() === 5) { // Friday
                    fridays.push(`${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                }
            }
            
            return fridays;
        }

        // Toolbar action handler
        function handleToolbarAction(action) {
            console.log('Toolbar action:', action);
            switch (action) {
                case '× ×§×” ×”×›×œ':
                    console.log('× ×§×” ×”×›×œ button clicked!');
                    clearAllAssignments();
                    break;
                // Auto-scheduling case removed - manual scheduling only
                case '×¡×˜×˜×™×¡×˜×™×§×•×ª':
                    console.log('×¡×˜×˜×™×¡×˜×™×§×•×ª button clicked!');
                    showSchedulingStatistics();
                    break;
                case '×—×•×§×™ ×©×™×‘×•×¥':
                    console.log('×—×•×§×™ ×©×™×‘×•×¥ button clicked!');
                    showCoordinatorRules();
                    break;
                case '×™×™×¦× ×œ××§×¡×œ':
                    console.log('×™×™×¦× ×œ××§×¡×œ button clicked!');
                    exportToExcel();
                    break;
                default:
                    console.log('Unknown toolbar action:', action);
            }
        }

        // Enhanced auto-scheduling function
        async function runAutoScheduling() {
            try {
                showNotification('××ª×—×™×œ ×©×™×‘×•×¥ ××•×˜×•××˜×™...', 'info');
                
                const [year, month] = currentMonth.split('-');
                console.log('Running auto-scheduling for:', { year, month });
                
                // Show configuration dialog
                const config = await showAutoSchedulingConfig();
                if (!config) {
                    showNotification('×©×™×‘×•×¥ ××•×˜×•××˜×™ ×‘×•×˜×œ', 'info');
                    return;
                }
                
                // Run enhanced auto-scheduling
                const response = await fetch(`${API_BASE}/schedule/auto-schedule-enhanced/${year}/${month}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`×©×™×‘×•×¥ ××•×˜×•××˜×™ ×”×•×©×œ× ×‘×”×¦×œ×—×”! ${result.stats.assigned} ×©×™×‘×•×¦×™× × ×•×¦×¨×•`, 'success');
                    
                    // Reload the schedule to show changes
                    await loadMonthSchedule(year, month);
                } else {
                    showNotification(`×©×’×™××” ×‘×©×™×‘×•×¥ ××•×˜×•××˜×™: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Error in auto-scheduling:', error);
                showNotification('×©×’×™××” ×‘×©×™×‘×•×¥ ××•×˜×•××˜×™', 'error');
            }
        }

        // Remove auto-scheduled assignments function
        async function removeAutoScheduled() {
            try {
                // Show confirmation dialog
                const confirmed = confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”×©×™×‘×•×¦×™× ×”××•×˜×•××˜×™×™×? ×©×™×‘×•×¦×™× ×™×“× ×™×™× ×™×™×©××¨×• ×œ×œ× ×©×™× ×•×™.');
                
                if (!confirmed) {
                    showNotification('×”×¤×¢×•×œ×” ×‘×•×˜×œ×”', 'info');
                    return;
                }
                
                showNotification('××•×—×§ ×©×™×‘×•×¦×™× ××•×˜×•××˜×™×™×...', 'info');
                
                const [year, month] = currentMonth.split('-');
                console.log('Removing auto-scheduled assignments for:', { year, month });
                
                // Call the remove endpoint
                const response = await fetch(`${API_BASE}/schedule/remove-auto-scheduled/${year}/${month}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`× ××—×§×• ${result.removedCount} ×©×™×‘×•×¦×™× ××•×˜×•××˜×™×™× ×‘×”×¦×œ×—×”`, 'success');
                    
                    // Reload the schedule to show changes
                    await loadMonthSchedule(year, month);
                } else {
                    showNotification(`×©×’×™××” ×‘××—×™×§×ª ×©×™×‘×•×¦×™× ××•×˜×•××˜×™×™×: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Error removing auto-scheduled assignments:', error);
                showNotification('×©×’×™××” ×‘××—×™×§×ª ×©×™×‘×•×¦×™× ××•×˜×•××˜×™×™×', 'error');
            }
        }

        // Show auto-scheduling configuration dialog
        function showAutoSchedulingConfig() {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>×”×’×“×¨×•×ª ×©×™×‘×•×¥ ××•×˜×•××˜×™</h2>
                            <span class="close" onclick="this.parentElement.parentElement.parentElement.remove(); resolve(null);">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="config-section">
                                <h3>××™×œ×•×¦×™× ×‘×¡×™×¡×™×™×</h3>
                                <div class="config-group">
                                    <label class="config-checkbox">
                                        <input type="checkbox" id="preserve_manual" checked>
                                        ×©××•×¨ ×©×™×‘×•×¦×™× ×™×“× ×™×™× (××•××œ×¥)
                                    </label>
                                </div>
                                
                                <div class="config-group">
                                    <label class="config-checkbox">
                                        <input type="checkbox" id="balance_workload" checked>
                                        ××™×–×•×Ÿ ×¢×•××¡×™× ××•×˜×•××˜×™
                                    </label>
                                </div>
                            </div>
                            
                            <div class="config-section">
                                <h3>×”×’×‘×œ×•×ª ××ª×§×“××•×ª</h3>
                                <div class="config-group">
                                    <label for="max_conan">××¡×¤×¨ ×›×•× × ×•×™×•×ª ××§×¡×™××œ×™ ×œ×—×•×“×©:</label>
                                    <select id="max_conan">
                                        <option value="1">1 ×›×•× × ×•×ª</option>
                                        <option value="2" selected>2 ×›×•× × ×•×™×•×ª</option>
                                        <option value="3">3 ×›×•× × ×•×™×•×ª</option>
                                    </select>
                                </div>
                                
                                <div class="config-group">
                                    <label class="config-checkbox">
                                        <input type="checkbox" id="dry_run">
                                        ×”×¨×¦×” × ×™×¡×™×•× ×™×ª (×œ× ×©×•××¨ ×©×™× ×•×™×™×)
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove(); resolve(null);">×‘×™×˜×•×œ</button>
                            <button class="btn btn-primary" onclick="submitAutoSchedulingConfig()">×”×ª×—×œ ×©×™×‘×•×¥</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Handle form submission
                window.submitAutoSchedulingConfig = () => {
                    const config = {
                        preserve_manual: document.getElementById('preserve_manual').checked,
                        balance_workload: document.getElementById('balance_workload').checked,
                        max_conan_per_guide: parseInt(document.getElementById('max_conan').value),
                        dry_run: document.getElementById('dry_run').checked
                    };
                    
                    modal.remove();
                    resolve(config);
                };
                
                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(null);
                    }
                });
            });
        }

        async function runAutoSchedulingAlgorithm(year, month, guides, currentSchedule, weekendTypes) {
            try {
                const days = getAllDaysInMonth(year, month);
                const schedule = [];
                const guideStats = {}; // Track guide statistics for balancing
                
                // Initialize guide statistics
                guides.forEach(guide => {
                    guideStats[guide.id] = {
                        totalShifts: 0,
                        weekendShifts: 0,
                        conanShifts: 0,
                        lastShiftDate: null,
                        weeklyShifts: {} // Track shifts per week
                    };
                });
                
                // Process each day
                for (const day of days) {
                    const date = day.date;
                    const weekday = day.weekday;
                    const weekendType = weekendTypes[date] || null;
                    
                    // Check if there's a manual assignment (sacred - don't change)
                    const existingAssignment = currentSchedule.find(s => s.date === date);
                    if (existingAssignment && existingAssignment.is_manual) {
                        schedule.push(existingAssignment);
                        
                        // Update statistics for manual assignments
                        if (existingAssignment.guide1_id) {
                            updateGuideStats(guideStats, existingAssignment.guide1_id, date, existingAssignment.guide1_role, weekday);
                        }
                        if (existingAssignment.guide2_id) {
                            updateGuideStats(guideStats, existingAssignment.guide2_id, date, existingAssignment.guide2_role, weekday);
                        }
                        continue;
                    }
                    
                    // Special handling for closed Saturday
                    if (weekendType === '×©×‘×ª ×¡×’×•×¨×”' && weekday === '×©×‘×ª') {
                        // Get the previous day's on-call guide
                        const previousDate = new Date(date);
                        previousDate.setDate(previousDate.getDate() - 1);
                        const prevDateStr = previousDate.toISOString().slice(0, 10);
                        
                        const prevAssignment = schedule.find(s => s.date === prevDateStr) || 
                                              currentSchedule.find(s => s.date === prevDateStr);
                        
                        let conanGuide = null;
                        if (prevAssignment && prevAssignment.guide1_role === '×›×•× ×Ÿ') {
                            conanGuide = guides.find(g => g.id === prevAssignment.guide1_id);
                        }
                        
                        // If we have a conan guide from Friday, use them for Saturday
                        if (conanGuide) {
                            const assignment = {
                                date: date,
                                weekday: weekday,
                                type: weekendType,
                                guide1_id: conanGuide.id,
                                guide1_name: conanGuide.name,
                                guide1_role: '×›×•× ×Ÿ',
                                guide2_id: null,
                                guide2_name: null,
                                guide2_role: null,
                                is_manual: false,
                                is_locked: false
                            };
                            
                            schedule.push(assignment);
                            updateGuideStats(guideStats, conanGuide.id, date, '×›×•× ×Ÿ', weekday);
                            continue;
                        }
                    }
                    
                    // Special handling for Saturday night (××•×¦×´×©) after closed Saturday
                    if (weekendType === '××•×¦×´×©' && weekday === '×©×‘×ª') {
                        // Get the current day's on-call guide (should be the same as Friday)
                        const currentAssignment = schedule.find(s => s.date === date) || 
                                                 currentSchedule.find(s => s.date === date);
                        
                        let conanGuide = null;
                        if (currentAssignment && currentAssignment.guide1_role === '×›×•× ×Ÿ') {
                            conanGuide = guides.find(g => g.id === currentAssignment.guide1_id);
                        }
                        
                        // If we have a conan guide, keep them and add an additional guide
                        if (conanGuide) {
                            // Get available guides for the additional role
                            const availableGuides = await getAvailableGuidesForDay(date, guides, guideStats, currentSchedule, weekendType);
                            const additionalGuides = availableGuides.filter(g => g.id !== conanGuide.id);
                            const selectedAdditional = selectBestGuides(additionalGuides, 1, guideStats, date, weekday);
                            
                            const assignment = {
                                date: date,
                                weekday: weekday,
                                type: weekendType,
                                guide1_id: conanGuide.id,
                                guide1_name: conanGuide.name,
                                guide1_role: '×›×•× ×Ÿ',
                                guide2_id: selectedAdditional[0]?.id || null,
                                guide2_name: selectedAdditional[0]?.name || null,
                                guide2_role: '×—×¤×™×¤×”',
                                is_manual: false,
                                is_locked: false
                            };
                            
                            // Update the existing assignment or add new one
                            const existingIndex = schedule.findIndex(s => s.date === date);
                            if (existingIndex >= 0) {
                                schedule[existingIndex] = assignment;
                            } else {
                                schedule.push(assignment);
                            }
                            
                            updateGuideStats(guideStats, conanGuide.id, date, '×›×•× ×Ÿ', weekday);
                            if (selectedAdditional[0]) {
                                updateGuideStats(guideStats, selectedAdditional[0].id, date, '×—×¤×™×¤×”', weekday);
                            }
                            continue;
                        }
                    }
                    
                    // Determine required guides and roles based on day type
                    const { requiredGuides, roles } = getRequiredGuidesForDay(weekendType, weekday);
                    
                    // Get available guides for this day
                    const availableGuides = await getAvailableGuidesForDay(date, guides, guideStats, currentSchedule, weekendType);
                    
                    // Select best guides based on balancing rules
                    const selectedGuides = selectBestGuides(availableGuides, requiredGuides, guideStats, date, weekday);
                    
                    // Create assignment
                    const assignment = {
                        date: date,
                        weekday: weekday,
                        type: weekendType || '×¨×’×™×œ',
                        guide1_id: selectedGuides[0]?.id || null,
                        guide1_name: selectedGuides[0]?.name || null,
                        guide1_role: roles[0] || null,
                        guide2_id: selectedGuides[1]?.id || null,
                        guide2_name: selectedGuides[1]?.name || null,
                        guide2_role: roles[1] || null,
                        is_manual: false,
                        is_locked: false
                    };
                    
                    schedule.push(assignment);
                    
                    // Update statistics
                    selectedGuides.forEach((guide, index) => {
                        if (guide) {
                            updateGuideStats(guideStats, guide.id, date, roles[index], weekday);
                        }
                    });
                }
                
                // Save the new schedule
                const response = await fetch(`${API_BASE}/schedule/auto-assign`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ year, month, schedule })
                });
                
                const result = await response.json();
                return result;
                
            } catch (error) {
                console.error('Error in auto-scheduling algorithm:', error);
                return { success: false, error: error.message };
            }
        }

        function getRequiredGuidesForDay(weekendType, weekday) {
            // Closed Saturday = 1 on-call guide
            if (weekendType === '×©×‘×ª ×¡×’×•×¨×”') {
                return { requiredGuides: 1, roles: ['×›×•× ×Ÿ'] };
            }
            
            // Saturday night (××•×¦×´×©) after closed Saturday = 2 guides (on-call + additional)
            if (weekendType === '××•×¦×´×©') {
                return { requiredGuides: 2, roles: ['×›×•× ×Ÿ', '×—×¤×™×¤×”'] };
            }
            
            // Open Saturday/Holiday = 2 guides (regular + overlap)
            if (weekendType === '×©×‘×ª ×¤×ª×•×—×”' || isHoliday(weekendType)) {
                return { requiredGuides: 2, roles: ['×¨×’×™×œ', '×—×¤×™×¤×”'] };
            }
            
            // Regular weekday = 2 guides
            return { requiredGuides: 2, roles: ['×¨×’×™×œ', '×—×¤×™×¤×”'] };
        }

        async function getAvailableGuidesForDay(date, guides, guideStats, currentSchedule, weekendType) {
            const available = [];
            
            for (const guide of guides) {
                if (guide.role !== '××“×¨×™×š') continue;
                
                // Check basic availability
                const availability = await checkGuideAvailability(guide.id, date);
                if (!availability.available) continue;
                
                // Check consecutive days rule
                if (hasConsecutiveDayViolation(guide.id, date, guideStats, weekendType)) continue;
                
                // Check weekly limit rule
                if (hasWeeklyLimitViolation(guide.id, date, guideStats)) continue;
                
                // Check on-call limit rule
                if (hasConanLimitViolation(guide.id, date, guideStats)) continue;
                
                available.push(guide);
            }
            
            return available;
        }

        async function checkGuideAvailability(guideId, date) {
            try {
                const response = await fetch(`${API_BASE}/guides/availability/${date}`);
                const availability = await response.json();
                const guideAvailability = availability.find(a => a.guide_id === guideId);
                
                return {
                    available: guideAvailability?.status === 'available',
                    reason: guideAvailability?.reason || null
                };
            } catch (error) {
                console.error('Error checking guide availability:', error);
                return { available: false, reason: '×©×’×™××” ×‘×‘×“×™×§×ª ×–××™× ×•×ª' };
            }
        }

        function hasConsecutiveDayViolation(guideId, date, guideStats, weekendType) {
            const stats = guideStats[guideId];
            if (!stats || !stats.lastShiftDate) return false;
            
            const lastShift = new Date(stats.lastShiftDate);
            const currentDate = new Date(date);
            const diffDays = Math.ceil((currentDate - lastShift) / (1000 * 60 * 60 * 24));
            
            // Rule: No consecutive days (except on-call on closed Saturday)
            if (diffDays <= 1) {
                // Check if this is an on-call assignment on a closed Saturday
                if (weekendType === '×©×‘×ª ×¡×’×•×¨×”') {
                    return false; // Allow consecutive days for on-call on closed Saturday
                }
                return true; // Violation for other cases
            }
            
            return false;
        }

        function hasWeeklyLimitViolation(guideId, date, guideStats) {
            const stats = guideStats[guideId];
            if (!stats) return false;
            
            const weekStart = getWeekStart(date);
            const weekKey = weekStart.toISOString().slice(0, 10);
            
            const weeklyCount = stats.weeklyShifts[weekKey] || 0;
            
            // Rule: Max 2 midweek shifts per guide per week (Sunday-Thursday)
            // Saturday night (××•×¦×´×©) doesn't count as midweek
            const currentDate = new Date(date);
            const currentWeekday = currentDate.getDay(); // 0=Sunday, 6=Saturday
            
            // Only apply limit to midweek days (Sunday-Thursday, days 0-4)
            if (currentWeekday >= 0 && currentWeekday <= 4) {
                return weeklyCount >= 2;
            }
            
            return false; // No limit for Friday/Saturday
        }

        function hasConanLimitViolation(guideId, date, guideStats) {
            const stats = guideStats[guideId];
            if (!stats) return false;
            
            // Rule: No on-call twice per month
            return stats.conanShifts >= 2;
        }

        function selectBestGuides(availableGuides, requiredCount, guideStats, date, weekday) {
            // Sort guides by score (lower score = better choice for balancing)
            const scoredGuides = availableGuides.map(guide => ({
                ...guide,
                score: calculateGuideScore(guide.id, guideStats, date, weekday)
            }));
            
            scoredGuides.sort((a, b) => a.score - b.score);
            
            return scoredGuides.slice(0, requiredCount);
        }

        function calculateGuideScore(guideId, guideStats, date, weekday) {
            const stats = guideStats[guideId] || { totalShifts: 0, weekendShifts: 0, conanShifts: 0 };
            
            let score = 0;
            
            // Prefer guides with fewer total shifts
            score += stats.totalShifts * 10;
            
            // Prefer guides with fewer weekend shifts
            score += stats.weekendShifts * 5;
            
            // Prefer guides with fewer on-call shifts
            score += stats.conanShifts * 8;
            
            // Prefer guides who haven't worked recently (2-day gap preference)
            if (stats.lastShiftDate) {
                const lastShift = new Date(stats.lastShiftDate);
                const currentDate = new Date(date);
                const diffDays = Math.ceil((currentDate - lastShift) / (1000 * 60 * 60 * 24));
                
                if (diffDays < 2) {
                    score += (2 - diffDays) * 15; // Penalty for recent work
                }
            }
            
            return score;
        }

        function updateGuideStats(guideStats, guideId, date, role, weekday) {
            if (!guideStats[guideId]) {
                guideStats[guideId] = {
                    totalShifts: 0,
                    weekendShifts: 0,
                    conanShifts: 0,
                    lastShiftDate: null,
                    weeklyShifts: {}
                };
            }
            
            const stats = guideStats[guideId];
            stats.totalShifts++;
            stats.lastShiftDate = date;
            
            // Track weekly shifts (only for midweek days - Sunday-Thursday)
            const currentDate = new Date(date);
            const currentWeekday = currentDate.getDay(); // 0=Sunday, 6=Saturday
            
            if (currentWeekday >= 0 && currentWeekday <= 4) {
                const weekStart = getWeekStart(date);
                const weekKey = weekStart.toISOString().slice(0, 10);
                stats.weeklyShifts[weekKey] = (stats.weeklyShifts[weekKey] || 0) + 1;
            }
            
            // Track role-specific shifts
            if (role === '×›×•× ×Ÿ') {
                stats.conanShifts++;
            }
            
            // Track weekend shifts
            if (weekday === '×©×™×©×™' || weekday === '×©×‘×ª') {
                stats.weekendShifts++;
            }
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day; // Adjust to Sunday
            return new Date(d.setDate(diff));
        }

        function isHoliday(weekendType) {
            // Add holiday detection logic here
            return weekendType && weekendType.includes('×—×’');
        }

        async function fetchWeekendTypes(year, month) {
            try {
                const response = await fetch(`${API_BASE}/weekend-types/${year}/${month}`);
                const result = await response.json();
                return result.weekendTypes || {};
            } catch (error) {
                console.error('Error fetching weekend types:', error);
                return {};
            }
        }

        function getAllDaysInMonth(year, month) {
            const days = [];
            const date = new Date(year, month - 1, 1);
            
            while (date.getMonth() === month - 1) {
                days.push({
                    date: date.toISOString().slice(0, 10),
                    weekday: getHebrewWeekday(date.getDay())
                });
                date.setDate(date.getDate() + 1);
            }
            
            return days;
        }

        function getHebrewWeekday(dayIndex) {
            const weekdays = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
            return weekdays[dayIndex];
        }

        function saveCurrentDraft() {
            showNotification('×¤×•× ×§×¦×™×” ×–×• ×ª×”×™×” ×–××™× ×” ×‘×©×œ×‘ ×”×‘×', 'info');
        }

        function loadDraft() {
            showNotification('×¤×•× ×§×¦×™×” ×–×• ×ª×”×™×” ×–××™× ×” ×‘×©×œ×‘ ×”×‘×', 'info');
        }

        function deleteDraft() {
            showNotification('×¤×•× ×§×¦×™×” ×–×• ×ª×”×™×” ×–××™× ×” ×‘×©×œ×‘ ×”×‘×', 'info');
        }

        async function clearAllAssignments() {
            console.log('clearAllAssignments function called!');
            // Ask for confirmation first
            const confirmed = confirm('×”×× ××ª×” ×‘×˜×•×— ×©××ª×” ×¨×•×¦×” ×œ× ×§×•×ª ××ª ×›×œ ×”×©×™×‘×•×¦×™× ×•×”×–×¨×™××ª ×”×¢×‘×•×“×” ×©×œ ×”×—×•×“×©?\n\n×¤×¢×•×œ×” ×–×• ×ª××—×§:\nâ€¢ ×›×œ ×”×©×™×‘×•×¦×™× ×©×œ ×”×—×•×“×©\nâ€¢ ×¡×˜×˜×•×¡ ×–×¨×™××ª ×”×¢×‘×•×“×”\nâ€¢ ×œ×•×—×•×ª ×–×× ×™× ×¨×©××™×™×\nâ€¢ ×”×™×¡×˜×•×¨×™×™×ª ×œ×•×—×•×ª ×–×× ×™×\nâ€¢ ×™×•×× ×™ ×“×•××´×œ\n\n×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.');
            
            if (!confirmed) {
                console.log('Clear operation cancelled by user');
                return;
            }
            
            try {
                showNotification('×× ×§×” ××ª ×›×œ ×”×©×™×‘×•×¦×™× ×•×–×¨×™××ª ×”×¢×‘×•×“×”...', 'info');
                
                const [year, month] = currentMonth.split('-');
                console.log('Clearing assignments and workflow for:', { year, month, currentMonth });
                
                // Clear all assignments and workflow for the month
                const response = await fetch(`${API_BASE}/schedule/clear-month`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ year, month })
                });
                
                console.log('Clear response status:', response.status);
                const result = await response.json();
                console.log('Clear response result:', result);
                
                if (result.success) {
                    let message = `×›×œ ×”×©×™×‘×•×¦×™× × ×•×§×• ×‘×”×¦×œ×—×” (${result.changes} ×©×™×‘×•×¦×™×)`;
                    if (result.workflowCleared) {
                        message += '\n×–×¨×™××ª ×”×¢×‘×•×“×” × ×•×§×ª×” ×’× ×›×Ÿ';
                    }
                    
                    showNotification(message, 'success');
                    
                    // Reload the month schedule to update the calendar
                    await loadMonthSchedule(year, month);
                    
                    // Clear selected guides if any
                    selectedGuides = [];
                    updateSelectedGuidesFromArray();
                    
                    // Refresh any workflow status displays if they exist
                    if (typeof refreshWorkflowStatus === 'function') {
                        refreshWorkflowStatus();
                    }
                } else {
                    showNotification('×©×’×™××” ×‘× ×™×§×•×™ ×”×©×™×‘×•×¦×™×', 'error');
                }
            } catch (error) {
                console.error('Error clearing assignments:', error);
                showNotification('×©×’×™××” ×‘× ×™×§×•×™ ×”×©×™×‘×•×¦×™×', 'error');
            }
        }

        // Show scheduling statistics
        async function showSchedulingStatistics() {
            try {
                const [year, month] = currentMonth.split('-');
                console.log('Fetching statistics for:', { year, month });
                
                const response = await fetch(`${API_BASE}/schedule/statistics/${year}/${month}`);
                const result = await response.json();
                
                if (result.success) {
                    displayStatisticsModal(result);
                } else {
                    showNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¡×˜×˜×™×¡×˜×™×§×•×ª', 'error');
                }
            } catch (error) {
                console.error('Error fetching statistics:', error);
                showNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¡×˜×˜×™×¡×˜×™×§×•×ª', 'error');
            }
        }
        
        // Display statistics in a modal
        function displayStatisticsModal(data) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>×¡×˜×˜×™×¡×˜×™×§×•×ª ×©×™×‘×•×¥ - ${currentMonth}</h2>
                        <span class="close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="stats-section">
                            <h3>×¡×˜×˜×™×¡×˜×™×§×•×ª ×™××™×</h3>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <span class="stat-label">×™××™× ×¢× ×©×™×‘×•×¥:</span>
                                    <span class="stat-value">${data.day_statistics.assigned_days || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">×™××™× ×¨×™×§×™×:</span>
                                    <span class="stat-value">${data.day_statistics.empty_days || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">×©×™×‘×•×¦×™× ×™×“× ×™×™×:</span>
                                    <span class="stat-value">${data.day_statistics.manual_days || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">×©×™×‘×•×¦×™× ××•×˜×•××˜×™×™×:</span>
                                    <span class="stat-value">${data.day_statistics.auto_days || 0}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-section">
                            <h3>×¡×˜×˜×™×¡×˜×™×§×•×ª ××“×¨×™×›×™×</h3>
                            <div class="guides-stats">
                                ${data.guide_statistics.map(guide => `
                                    <div class="guide-stat">
                                        <div class="guide-name">${guide.name}</div>
                                        <div class="guide-stats-grid">
                                            <span>×¡×”"×›: ${guide.total_shifts}</span>
                                            <span>×™×“× ×™: ${guide.manual_shifts}</span>
                                            <span>××•×˜×•××˜×™: ${guide.auto_shifts}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function exportToExcel() {
            showNotification('×¤×•× ×§×¦×™×” ×–×• ×ª×”×™×” ×–××™× ×” ×‘×©×œ×‘ ×”×‘×', 'info');
        }

        // Coordinator Rules Management
        async function showCoordinatorRules() {
            try {
                const response = await fetch(`${API_BASE}/coordinator-rules`);
                const result = await response.json();
                
                if (result.success) {
                    displayCoordinatorRulesModal(result.rules);
                } else {
                    showNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ×—×•×§×™ ×”×©×™×‘×•×¥', 'error');
                }
            } catch (error) {
                console.error('Error fetching coordinator rules:', error);
                showNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ×—×•×§×™ ×”×©×™×‘×•×¥', 'error');
            }
        }

        function displayCoordinatorRulesModal(rules) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>×—×•×§×™ ×©×™×‘×•×¥ ×“×™× ×××™×™×</h2>
                        <span class="close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="rules-section">
                            <div class="rules-header">
                                <h3>×—×•×§×™× ×¤×¢×™×œ×™×</h3>
                                <button class="btn btn-success" onclick="addNewRule()">
                                    <span class="icon">â•</span>
                                    ×”×•×¡×£ ×—×•×§ ×—×“×©
                                </button>
                            </div>
                            <div class="rules-list">
                                ${rules.map(rule => `
                                    <div class="rule-item" data-rule-id="${rule.id}">
                                        <div class="rule-info">
                                            <div class="rule-type">
                                                <span class="rule-icon">${getRuleIcon(rule.rule_type)}</span>
                                                <span class="rule-title">${getRuleTitle(rule.rule_type)}</span>
                                            </div>
                                            <div class="rule-description">${rule.description}</div>
                                            <div class="rule-guides">
                                                ${rule.guide1_name}${rule.guide2_name ? ` + ${rule.guide2_name}` : ''}
                                            </div>
                                        </div>
                                        <div class="rule-actions">
                                            <button class="btn btn-sm btn-warning" onclick="editRule(${rule.id})">
                                                <span class="icon">âœï¸</span>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteRule(${rule.id})">
                                                <span class="icon">ğŸ—‘ï¸</span>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function getRuleIcon(ruleType) {
            const icons = {
                'no_auto_scheduling': 'ğŸ¤–',
                'no_conan': 'ğŸš«',
                'no_together': 'ğŸ‘¥'
            };
            return icons[ruleType] || 'ğŸ“‹';
        }

        function getRuleTitle(ruleType) {
            const titles = {
                'no_auto_scheduling': '×œ× ×œ×©×‘×¥ ×‘××•×˜×•××˜×™',
                'no_conan': '×œ× ×œ×©×‘×¥ ×›×›×•× ×Ÿ',
                'no_together': '×œ× ×œ×¢×‘×•×“ ×™×—×“'
            };
            return titles[ruleType] || '×—×•×§ ×œ× ×™×“×•×¢';
        }

        // Coordinator Rules CRUD Functions
        async function addNewRule() {
            try {
                // First, get all guides for the dropdown
                const guidesResponse = await fetch(`${API_BASE}/guides/enhanced`);
                const guidesResult = await guidesResponse.json();
                
                // The API returns an array directly, not an object with success/guides
                const guides = Array.isArray(guidesResult) ? guidesResult : [];
                
                if (guides.length === 0) {
                    showNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ×”××“×¨×™×›×™×', 'error');
                    return;
                }
                
                // Create modal for adding new rule
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>×”×•×¡×£ ×—×•×§ ×—×“×©</h2>
                            <span class="close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <form id="newRuleForm">
                                <div class="form-group">
                                    <label for="ruleType">×¡×•×’ ×”×—×•×§:</label>
                                    <select id="ruleType" required onchange="updateRuleForm()">
                                        <option value="">×‘×—×¨ ×¡×•×’ ×—×•×§...</option>
                                        <option value="no_auto_scheduling">×œ× ×œ×©×‘×¥ ×‘××•×˜×•××˜×™</option>
                                        <option value="no_conan">×œ× ×œ×©×‘×¥ ×›×›×•× ×Ÿ</option>
                                        <option value="no_together">×œ× ×œ×¢×‘×•×“ ×™×—×“</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="guide1">××“×¨×™×š ×¨××©×•×Ÿ:</label>
                                    <select id="guide1" required>
                                        <option value="">×‘×—×¨ ××“×¨×™×š...</option>
                                        ${guides.map(guide => `<option value="${guide.id}">${guide.name}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="form-group" id="guide2Group" style="display: none;">
                                    <label for="guide2">××“×¨×™×š ×©× ×™:</label>
                                    <select id="guide2">
                                        <option value="">×‘×—×¨ ××“×¨×™×š...</option>
                                        ${guides.map(guide => `<option value="${guide.id}">${guide.name}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="description">×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™):</label>
                                    <input type="text" id="description" placeholder="×ª×™××•×¨ ×”×—×•×§...">
                                </div>
                                
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">×‘×™×˜×•×œ</button>
                                    <button type="submit" class="btn btn-success">×”×•×¡×£ ×—×•×§</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Handle form submission
                document.getElementById('newRuleForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await submitNewRule();
                });
                
                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
            } catch (error) {
                console.error('Error creating new rule form:', error);
                showNotification('×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×•×¤×¡ ×”×—×•×§', 'error');
            }
        }

        function updateRuleForm() {
            const ruleType = document.getElementById('ruleType').value;
            const guide2Group = document.getElementById('guide2Group');
            const guide2 = document.getElementById('guide2');
            
            if (ruleType === 'no_together') {
                guide2Group.style.display = 'block';
                guide2.required = true;
            } else {
                guide2Group.style.display = 'none';
                guide2.required = false;
                guide2.value = '';
            }
        }

        async function submitNewRule() {
            try {
                const ruleType = document.getElementById('ruleType').value;
                const guide1Id = document.getElementById('guide1').value;
                const guide2Id = document.getElementById('guide2').value;
                const description = document.getElementById('description').value;
                
                if (!ruleType || !guide1Id) {
                    showNotification('×—×•×‘×” ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×', 'error');
                    return;
                }
                
                if (ruleType === 'no_together' && !guide2Id) {
                    showNotification('×—×•×§ "×œ× ×œ×¢×‘×•×“ ×™×—×“" ×“×•×¨×© ×©× ×™ ××“×¨×™×›×™×', 'error');
                    return;
                }
                
                if (guide1Id === guide2Id) {
                    showNotification('×œ× × ×™×ª×Ÿ ×œ×‘×—×•×¨ ××ª ××•×ª×• ××“×¨×™×š ×¤×¢××™×™×', 'error');
                    return;
                }
                
                const response = await fetch(`${API_BASE}/coordinator-rules`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        rule_type: ruleType,
                        guide1_id: parseInt(guide1Id),
                        guide2_id: guide2Id ? parseInt(guide2Id) : null,
                        description: description || null
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('×”×—×•×§ × ×•×¡×£ ×‘×”×¦×œ×—×”', 'success');
                    // Close the modal
                    document.querySelector('.modal').remove();
                    // Refresh the main rules modal
                    await refreshCurrentRulesModal();
                } else {
                    showNotification(`×©×’×™××” ×‘×”×•×¡×¤×ª ×”×—×•×§: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error submitting new rule:', error);
                showNotification('×©×’×™××” ×‘×”×•×¡×¤×ª ×”×—×•×§', 'error');
            }
        }

        async function editRule(ruleId) {
            showNotification('×¢×¨×™×›×ª ×—×•×§ - ×‘×§×¨×•×‘', 'info');
        }

        async function deleteRule(ruleId) {
            try {
                const confirmed = confirm('×”×× ××ª×” ×‘×˜×•×— ×©××ª×” ×¨×•×¦×” ×œ××—×•×§ ××ª ×”×—×•×§ ×”×–×”?');
                if (!confirmed) return;

                const response = await fetch(`${API_BASE}/coordinator-rules/${ruleId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                if (result.success) {
                    showNotification('×”×—×•×§ × ××—×§ ×‘×”×¦×œ×—×”', 'success');
                    // Refresh the current modal instead of creating a new one
                    refreshCurrentRulesModal();
                } else {
                    showNotification('×©×’×™××” ×‘××—×™×§×ª ×”×—×•×§', 'error');
                }
            } catch (error) {
                console.error('Error deleting rule:', error);
                showNotification('×©×’×™××” ×‘××—×™×§×ª ×”×—×•×§', 'error');
            }
        }

        async function refreshCurrentRulesModal() {
            try {
                const response = await fetch(`${API_BASE}/coordinator-rules`);
                const result = await response.json();
                
                if (result.success) {
                    // Find the current modal and update its content
                    const currentModal = document.querySelector('.modal');
                    if (currentModal) {
                        const modalBody = currentModal.querySelector('.modal-body');
                        if (modalBody) {
                            modalBody.innerHTML = `
                                <div class="rules-section">
                                    <div class="rules-header">
                                        <h3>×—×•×§×™× ×¤×¢×™×œ×™×</h3>
                                        <button class="btn btn-success" onclick="addNewRule()">
                                            <span class="icon">â•</span>
                                            ×”×•×¡×£ ×—×•×§ ×—×“×©
                                        </button>
                                    </div>
                                    <div class="rules-list">
                                        ${result.rules.map(rule => `
                                            <div class="rule-item" data-rule-id="${rule.id}">
                                                <div class="rule-info">
                                                    <div class="rule-type">
                                                        <span class="rule-icon">${getRuleIcon(rule.rule_type)}</span>
                                                        <span class="rule-title">${getRuleTitle(rule.rule_type)}</span>
                                                    </div>
                                                    <div class="rule-description">${rule.description}</div>
                                                    <div class="rule-guides">
                                                        ${rule.guide1_name}${rule.guide2_name ? ` + ${rule.guide2_name}` : ''}
                                                    </div>
                                                </div>
                                                <div class="rule-actions">
                                                    <button class="btn btn-sm btn-warning" onclick="editRule(${rule.id})">
                                                        <span class="icon">âœï¸</span>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger" onclick="deleteRule(${rule.id})">
                                                        <span class="icon">ğŸ—‘ï¸</span>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                    }
                }
            } catch (error) {
                console.error('Error refreshing rules modal:', error);
            }
        }

        // =====================================================
        // WORKFLOW FUNCTIONS
        // =====================================================

        // Load workflow status when month changes
        async function loadWorkflowStatus(month) {
            try {
                // Clean the month parameter - remove any extra characters
                const cleanMonth = month.split(':')[0]; // Remove anything after colon
                console.log('Loading workflow status for month:', cleanMonth);
                
                const response = await fetch(`${API_BASE}/workflow/status/${cleanMonth}`);
                workflowStatus = await response.json();
                
                console.log('Workflow status loaded:', workflowStatus);
                updateWorkflowUI();
                
                return workflowStatus;
            } catch (error) {
                console.error('Error loading workflow status:', error);
                showNotification('×©×’×™××” ×‘×˜×¢×™× ×ª ×¡×˜×˜×•×¡ ×”×ª×”×œ×™×š', 'error');
            }
        }

        // Update UI based on workflow status
        function updateWorkflowUI() {
            if (!workflowStatus) return;
            
            isFinalized = workflowStatus.is_finalized;
            availableDrafts = workflowStatus.drafts_available || [];
            
            updateWorkflowButtons();
            updateWorkflowPanel();
            
            if (isFinalized) {
                makeInterfaceReadOnly();
            }
        }

        // Update workflow-related buttons in toolbar
        function updateWorkflowButtons() {
            const toolbar = document.querySelector('.toolbar');
            
            // Remove existing workflow section
            const existingWorkflowSection = toolbar.querySelector('.workflow-section');
            if (existingWorkflowSection) {
                existingWorkflowSection.remove();
            }
            
            // Create workflow section
            const workflowSection = document.createElement('div');
            workflowSection.className = 'toolbar-section workflow-section';
            
            if (isFinalized) {
                workflowSection.innerHTML = `
                    <h3>ğŸ”’ ×—×•×“×© ×××•×©×¨</h3>
                    <button class="btn btn-info" onclick="viewOfficialSchedule()">
                        <span class="icon">ğŸ“‹</span>
                        ×¦×¤×” ×‘×œ×•×— ×¨×©××™
                    </button>
                `;
            } else {
                workflowSection.innerHTML = `
                    <h3>×ª×”×œ×™×š ×¢×‘×•×“×”</h3>
                    <button class="btn btn-success" onclick="createFirstDraft()" ${workflowStatus.current_draft_version > 0 ? 'style="display:none"' : ''}>
                        <span class="icon">ğŸ“</span>
                        ×˜×™×•×˜×” ×¨××©×•× ×”
                    </button>
                    <button class="btn btn-primary" onclick="saveNewDraft()" ${workflowStatus.current_draft_version === 0 ? 'style="display:none"' : ''}>
                        <span class="icon">ğŸ’¾</span>
                        ×©××•×¨ ×˜×™×•×˜×” ×—×“×©×”
                    </button>
                    <button class="btn btn-warning" onclick="sendToGuides()" ${workflowStatus.current_draft_version === 0 ? 'style="display:none"' : ''}>
                        <span class="icon">ğŸ“§</span>
                        ×©×œ×— ×œ××“×¨×™×›×™×
                    </button>
                    <button class="btn btn-danger" onclick="finalizeSchedule()" ${workflowStatus.current_draft_version === 0 ? 'style="display:none"' : ''}>
                        <span class="icon">âœ…</span>
                        ××©×¨ ×œ×•×— ×¨×©××™
                    </button>
                `;
            }
            
            // Insert workflow section after automatic scheduling section
            const autoSchedulingSection = toolbar.querySelector('.toolbar-section:first-child');
            if (autoSchedulingSection) {
                autoSchedulingSection.insertAdjacentElement('afterend', workflowSection);
            }
        }

        // Add workflow status panel
        function updateWorkflowPanel() {
            // Remove existing workflow panel
            const existingPanel = document.querySelector('.workflow-status-panel');
            if (existingPanel) {
                existingPanel.remove();
            }
            
            // Create workflow status panel
            const panel = document.createElement('div');
            panel.className = 'workflow-status-panel';
            
            const currentDraft = workflowStatus.current_draft_version;
            
            panel.innerHTML = `
                <div class="workflow-status ${isFinalized ? 'finalized' : 'active'}">
                    <h4>${isFinalized ? 'ğŸ”’ ×—×•×“×© ×××•×©×¨' : 'ğŸ“ ×ª×”×œ×™×š ×¢×‘×•×“×”'} - ${currentMonth}</h4>
                    <p>
                        ${isFinalized 
                            ? '×”×œ×•×— ××•×©×¨ ×•×œ× × ×™×ª×Ÿ ×œ×©×™× ×•×™' 
                            : `×˜×™×•×˜×” × ×•×›×—×™×ª: ${currentDraft > 0 ? `×’×¨×¡×” ${currentDraft}` : '×œ× × ×•×¦×¨×”'}`
                        }
                    </p>
                </div>
            `;
            
            // Insert panel after header
            const header = document.querySelector('.header');
            if (header) {
                header.insertAdjacentElement('afterend', panel);
            }
        }

        // Make interface read-only when finalized
        function makeInterfaceReadOnly() {
            const editButtons = document.querySelectorAll('.edit-day-btn');
            editButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
        }

        // Create first draft
        async function createFirstDraft() {
            try {
                const cleanMonth = currentMonth.split(':')[0]; // Clean the month parameter
                const confirmed = confirm('×”×× ××ª×” ×‘×˜×•×— ×©××ª×” ×¨×•×¦×” ×œ×™×¦×•×¨ ×˜×™×•×˜×” ×¨××©×•× ×”?');
                if (!confirmed) return;
                
                showNotification('×™×•×¦×¨ ×˜×™×•×˜×” ×¨××©×•× ×”...', 'info');
                
                const response = await fetch(`${API_BASE}/workflow/create-draft/${cleanMonth}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ created_by: 1 })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`×˜×™×•×˜×” ×¨××©×•× ×” × ×•×¦×¨×” ×‘×”×¦×œ×—×”!`, 'success');
                    await loadWorkflowStatus(cleanMonth);
                } else {
                    showNotification(`×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×™×•×˜×”: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Error creating first draft:', error);
                showNotification('×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×™×•×˜×” ×¨××©×•× ×”', 'error');
            }
        }

        // Save new draft
        async function saveNewDraft() {
            try {
                const cleanMonth = currentMonth.split(':')[0]; // Clean the month parameter
                showNotification('×©×•××¨ ×˜×™×•×˜×” ×—×“×©×”...', 'info');
                
                const response = await fetch(`${API_BASE}/workflow/create-draft/${cleanMonth}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ created_by: 1 })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`×˜×™×•×˜×” ×—×“×©×” × ×©××¨×” ×‘×”×¦×œ×—×”!`, 'success');
                    await loadWorkflowStatus(cleanMonth);
                } else {
                    showNotification(`×©×’×™××” ×‘×©××™×¨×ª ×˜×™×•×˜×”: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Error saving new draft:', error);
                showNotification('×©×’×™××” ×‘×©××™×¨×ª ×˜×™×•×˜×” ×—×“×©×”', 'error');
            }
        }

        // Send to guides
        async function sendToGuides() {
            try {
                const cleanMonth = currentMonth.split(':')[0]; // Clean the month parameter
                if (workflowStatus.current_draft_version === 0) {
                    showNotification('×™×© ×œ×™×¦×•×¨ ×˜×™×•×˜×” ×œ×¤× ×™ ×©×œ×™×—×” ×œ××“×¨×™×›×™×', 'warning');
                    return;
                }
                
                const confirmed = confirm(`×”×× ×œ×©×œ×•×— ×˜×™×•×˜×” ×’×¨×¡×” ${workflowStatus.current_draft_version} ×œ×›×œ ×”××“×¨×™×›×™×?`);
                if (!confirmed) return;
                
                showNotification('×©×•×œ×— ×˜×™×•×˜×” ×œ××“×¨×™×›×™×...', 'info');
                
                const response = await fetch(`${API_BASE}/workflow/send-to-guides/${cleanMonth}/${workflowStatus.current_draft_version}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sent_by: 1 })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`× ×©×œ×— ×œ-${result.total_recipients} ××“×¨×™×›×™× ×‘×”×¦×œ×—×”!`, 'success');
                    await loadWorkflowStatus(cleanMonth);
                } else {
                    showNotification(`×©×’×™××” ×‘×©×œ×™×—×”: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Error sending to guides:', error);
                showNotification('×©×’×™××” ×‘×©×œ×™×—×” ×œ××“×¨×™×›×™×', 'error');
            }
        }

        // Finalize schedule
        async function finalizeSchedule() {
            try {
                const cleanMonth = currentMonth.split(':')[0]; // Clean the month parameter
                const confirmed = confirm(`×”×× ××ª×” ×‘×˜×•×— ×©××ª×” ×¨×•×¦×” ×œ××©×¨ ××ª ×”×œ×•×— ×œ×—×•×“×© ${cleanMonth} ×›×¨×©××™?\n\n×œ××—×¨ ××™×©×•×¨ ×œ× × ×™×ª×Ÿ ×™×”×™×” ×œ×‘×¦×¢ ×©×™× ×•×™×™×!`);
                if (!confirmed) return;
                
                showNotification('×××©×¨ ×œ×•×— ×¨×©××™...', 'info');
                
                const response = await fetch(`${API_BASE}/workflow/finalize/${cleanMonth}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ finalized_by: 1 })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`×œ×•×— ×—×•×“×© ${cleanMonth} ××•×©×¨ ×‘×”×¦×œ×—×” ×›×¨×©××™!`, 'success');
                    await loadWorkflowStatus(cleanMonth);
                } else {
                    showNotification(`×©×’×™××” ×‘××™×©×•×¨ ×”×œ×•×—: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Error finalizing schedule:', error);
                showNotification('×©×’×™××” ×‘××™×©×•×¨ ×”×œ×•×— ×”×¨×©××™', 'error');
            }
        }

        // Placeholder functions
        function viewOfficialSchedule() {
            showNotification('××¢×‘×™×¨ ×œ×œ×•×— ×”×¨×©××™ - ×‘×§×¨×•×‘', 'info');
        }
    </script>

    <!-- Footer -->
    <div id="main-footer">
        <span class="footer-icon">ğŸŒ¸</span>
        <span>×¡×™×’×œ×™×ª &copy; 2024 | ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª</span>
    </div>
    <script src="config.js"></script>
</body>
</html>